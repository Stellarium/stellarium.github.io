<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux fomalhaut.local 3.13.0-38-generic #65-Ubuntu SMP Thu Oct 9 11:36:50 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 4.0.1 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.3 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 1.2.1 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: StelSkyDrawer.cpp - StelSkyDrawer.cpp</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;StelSkyDrawer.cpp&nbsp;</th><th> </th><th>&nbsp;StelSkyDrawer.cpp&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 20</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 20</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This program is distributed in the hope that it will be useful,</td><td> </td><td class="right"> * This program is distributed in the hope that it will be useful,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td> </td><td class="right"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td> </td><td class="right"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * GNU General Public License for more details.</td><td> </td><td class="right"> * GNU General Public License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with this program; if not, write to the Free Software</td><td> </td><td class="right"> * along with this program; if not, write to the Free Software</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Foundation, Inc., 51 Franklin Street, Suite 500, Boston, MA  02110-1335,
 USA.</td><td> </td><td class="right"> * Foundation, Inc., 51 Franklin Street, Suite 500, Boston, MA  02110-1335,
 USA.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifndef GL_POINT_SPRITE</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> #define GL_POINT_SPRITE 0x8861</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifndef GL_VERTEX_PROGRAM_POINT_SIZE</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> #define GL_VERTEX_PROGRAM_POINT_SIZE 0x8642</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelSkyDrawer.hpp"</td><td> </td><td class="right">#include "StelSkyDrawer.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelProjector.hpp"</td><td> </td><td class="right">#include "StelProjector.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "StelFileMgr.hpp"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelToneReproducer.hpp"</td><td> </td><td class="right">#include "StelToneReproducer.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">#include <span class="delete">"renderer/StelTextureNew.hpp"</span></td><td> </td><td class="rblock">#include <span class="insert">"StelTextureMgr.hpp"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#include "renderer/StelRenderer.hpp"</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelApp.hpp"</td><td> </td><td class="right">#include "StelApp.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelCore.hpp"</td><td> </td><td class="right">#include "StelCore.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelUtils.hpp"</td><td> </td><td class="right">#include "StelUtils.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelMovementMgr.hpp"</td><td> </td><td class="right">#include "StelMovementMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "StelPainter.hpp"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include &lt;QOpenGLContext&gt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include &lt;QOpenGLShaderProgram&gt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QStringList&gt;</td><td> </td><td class="right">#include &lt;QStringList&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QSettings&gt;</td><td> </td><td class="right">#include &lt;QSettings&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QDebug&gt;</td><td> </td><td class="right">#include &lt;QDebug&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QtGlobal&gt;</td><td> </td><td class="right">#include &lt;QtGlobal&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// The 0.025 corresponds to the maximum eye resolution in degree</td><td> </td><td class="right">// The 0.025 corresponds to the maximum eye resolution in degree</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define EYE_RESOLUTION (0.25f)</td><td> </td><td class="right">#define EYE_RESOLUTION (0.25f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">#define MAX_LINEAR_RADIUS <span class="delete">(8.f)</span></td><td> </td><td class="rblock">#define MAX_LINEAR_RADIUS <span class="insert">8.f</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">StelSkyDrawer::StelSkyDrawer(StelCore* acore, StelRenderer* renderer)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       : core(acore)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , renderer(renderer)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , texHalo(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , starPointBuffer(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , starSpriteBuffer(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , drawing(false)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , texBigHalo(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , texSunHalo(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , texCorona(NULL)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , statisticsInitialized(false)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , bigHaloStatID(-1)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , sunHaloStatID(-1)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       , starStatID(-1)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       eye = core-&gt;getToneReproducer();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       inScale = 1.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       bortleScaleIndex = 3;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       limitMagnitude = -100.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       limitLuminance = 0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       oldLum=-1.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       maxLum = 0.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       setMaxAdaptFov(180.f);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       setMinAdaptFov(0.1f);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       starAbsoluteScaleF = 1.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       starRelativeScale = 1.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       starLinearScale = 19.569f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       big3dModelHaloRadius = 150.f;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">StelSkyDrawer::StelSkyDrawer(StelCore* acore) :</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       core(acore),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       eye(acore-&gt;getToneReproducer()),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       maxAdaptFov(180.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       minAdaptFov(0.1f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       lnfovFactor(0.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starRelativeScale(1.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starAbsoluteScaleF(1.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starLinearScale(19.569f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       limitMagnitude(-100.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       limitLuminance(0.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       bortleScaleIndex(3),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       inScale(1.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram(NULL),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars(StarShaderVars()),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       maxLum(0.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       oldLum(-1.f),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       big3dModelHaloRadius(150.f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">{</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QSettings* conf = StelApp::getInstance().getSettings();</td><td> </td><td class="right">       QSettings* conf = StelApp::getInstance().getSettings();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       initColorTableFromConfigFile(conf);</td><td> </td><td class="right">       initColorTableFromConfigFile(conf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setFlagHasAtmosphere(conf-&gt;value("landscape/flag_atmosphere", true).
toBool());</td><td> </td><td class="right">       setFlagHasAtmosphere(conf-&gt;value("landscape/flag_atmosphere", true).
toBool());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setTwinkleAmount(conf-&gt;value("stars/star_twinkle_amount",0.3).toFloa
t());</td><td> </td><td class="right">       setTwinkleAmount(conf-&gt;value("stars/star_twinkle_amount",0.3).toFloa
t());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setFlagTwinkle(conf-&gt;value("stars/flag_star_twinkle",true).toBool())
;</td><td> </td><td class="right">       setFlagTwinkle(conf-&gt;value("stars/flag_star_twinkle",true).toBool())
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       setDrawStarsAsPoints(conf-&gt;value("stars/flag_point_star",false).toBo
ol());</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setMaxAdaptFov(conf-&gt;value("stars/mag_converter_max_fov",70.0).toFlo
at());</td><td> </td><td class="right">       setMaxAdaptFov(conf-&gt;value("stars/mag_converter_max_fov",70.0).toFlo
at());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setMinAdaptFov(conf-&gt;value("stars/mag_converter_min_fov",0.1).toFloa
t());</td><td> </td><td class="right">       setMinAdaptFov(conf-&gt;value("stars/mag_converter_min_fov",0.1).toFloa
t());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setFlagLuminanceAdaptation(conf-&gt;value("viewing/use_luminance_adapta
tion",true).toBool());</td><td> </td><td class="right">       setFlagLuminanceAdaptation(conf-&gt;value("viewing/use_luminance_adapta
tion",true).toBool());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setFlagStarMagnitudeLimit((conf-&gt;value("astro/flag_star_magnitude_li
mit", false).toBool()));</td><td> </td><td class="right">       setFlagStarMagnitudeLimit((conf-&gt;value("astro/flag_star_magnitude_li
mit", false).toBool()));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setCustomStarMagnitudeLimit(conf-&gt;value("astro/star_magnitude_limit"
, 6.5).toFloat());</td><td> </td><td class="right">       setCustomStarMagnitudeLimit(conf-&gt;value("astro/star_magnitude_limit"
, 6.5).toFloat());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setFlagNebulaMagnitudeLimit((conf-&gt;value("astro/flag_nebula_magnitud
e_limit", false).toBool()));</td><td> </td><td class="right">       setFlagNebulaMagnitudeLimit((conf-&gt;value("astro/flag_nebula_magnitud
e_limit", false).toBool()));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setCustomNebulaMagnitudeLimit(conf-&gt;value("astro/nebula_magnitude_li
mit", 8.5).toFloat());</td><td> </td><td class="right">       setCustomNebulaMagnitudeLimit(conf-&gt;value("astro/nebula_magnitude_li
mit", 8.5).toFloat());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // qDebug() &lt;&lt; "drawer: clampStellarMag: " &lt;&lt; clampStellarMagnitude 
&lt;&lt; " , clampDSOmagnitude: " &lt;&lt; clampDSOMagnitude;</td><td> </td><td class="right">       // qDebug() &lt;&lt; "drawer: clampStellarMag: " &lt;&lt; clampStellarMagnitude 
&lt;&lt; " , clampDSOmagnitude: " &lt;&lt; clampDSOMagnitude;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       bool ok=true;</td><td> </td><td class="right">       bool ok=true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       setBortleScale<span class="delete">(conf-&gt;value("stars/init_bortle_scale",3).toInt(&amp;</span>ok));</td><td> </td><td class="rblock">       setBortleScale<span class="insert">Index(conf-&gt;value("stars/init_bortle_scale",2).toInt(&amp;
</span>ok));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock">               <span class="insert">setBortleScaleIndex(2);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("stars/init_bortle_scale",3);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               setBortleScale(3);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               ok = true;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setRelativeStarScale(conf-&gt;value("stars/relative_scale",1.0).toFloat
(&amp;ok));</td><td> </td><td class="right">       setRelativeStarScale(conf-&gt;value("stars/relative_scale",1.0).toFloat
(&amp;ok));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("stars/relative_scale",1.0);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               setRelativeStarScale(1.0);</td><td> </td><td class="right">               setRelativeStarScale(1.0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">ok = true;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setAbsoluteStarScale(conf-&gt;value("stars/absolute_scale",1.0).toFloat
(&amp;ok));</td><td> </td><td class="right">       setAbsoluteStarScale(conf-&gt;value("stars/absolute_scale",1.0).toFloat
(&amp;ok));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("stars/absolute_scale",1.0);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               setAbsoluteStarScale(1.0);</td><td> </td><td class="right">               setAbsoluteStarScale(1.0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">ok = true;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">//GZ: load 3 values from config.</span></td><td> </td><td class="rblock">       setExtinctionCoefficient(conf-&gt;value("landscape/atmospheric_extincti</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       setExtinctionCoefficient(conf-&gt;value("landscape/atmospheric_extincti</td><td> </td><td class="rblock"><span class="insert">on_coefficient",0.13).toDouble(&amp;ok));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">on_coefficient",0.2).toDouble(&amp;ok));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("landscape/atmospheric_extinction_coefficient</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">",0.2);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               setExtinctionCoefficient(0.2);</td><td> </td><td class="right">               setExtinctionCoefficient(0.2);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">ok</span> = <span class="delete">true;</span></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock">       <span class="insert">const QString extinctionMode</span> = <span class="insert">conf-&gt;value("astro/extinction_mode_be</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">low_horizon", "zero").toString();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // zero by default</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (extinctionMode=="mirror")</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               extinction.setUndergroundExtinctionMode(Extinction::Undergro</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">undExtinctionMirror);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       else if (extinctionMode=="max")</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               extinction.setUndergroundExtinctionMode(Extinction::Undergro</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">undExtinctionMax);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setAtmosphereTemperature(conf-&gt;value("landscape/temperature_C",15.0)
.toDouble(&amp;ok));</td><td> </td><td class="right">       setAtmosphereTemperature(conf-&gt;value("landscape/temperature_C",15.0)
.toDouble(&amp;ok));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("landscape/temperature_C",15);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               setAtmosphereTemperature(15.0);</td><td> </td><td class="right">               setAtmosphereTemperature(15.0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">ok = true;</span></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       setAtmospherePressure(conf-&gt;value("landscape/pressure_mbar",1013.0).
toDouble(&amp;ok));</td><td> </td><td class="right">       setAtmospherePressure(conf-&gt;value("landscape/pressure_mbar",1013.0).
toDouble(&amp;ok));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!ok)</td><td> </td><td class="right">       if (!ok)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               conf-&gt;setValue("landscape/pressure_mbar",1013.0);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               setAtmospherePressure(1013.0);</td><td> </td><td class="right">               setAtmospherePressure(1013.0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">ok = true;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">starPointBuffer</span>   = <span class="delete">renderer-&gt;createVertexBuffer&lt;ColoredVertex&gt;(Prim</span></td><td> </td><td class="rblock">       <span class="insert">// Initialize buffers for use by gl vertex array</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">itiveType_Points);</span></td><td> </td><td class="rblock"><span class="insert">       nbPointSources</span> = <span class="insert">0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       starSpriteBuffer  = renderer-&gt;createVertexBuffer&lt;ColoredTexturedVert</span></td><td> </td><td class="rblock"><span class="insert">       maxPointSources</span> = <span class="insert">1000;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ex&gt;(PrimitiveType_Triangles);</span></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       bigHaloBuffer     = renderer-&gt;createVertexBuffer&lt;ColoredTexturedVert</span></td><td> </td><td class="rblock"><span class="insert">       vertexArray = new StarVertex[maxPointSources*6];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ex&gt;(PrimitiveType_Triangles);</span></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       sunHaloBuffer     = renderer-&gt;createVertexBuffer&lt;ColoredTexturedVert</span></td><td> </td><td class="rblock"><span class="insert">       textureCoordArray = new unsigned char[maxPointSources*6*2];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ex&gt;(PrimitiveType_Triangles);</span></td><td> </td><td class="rblock"><span class="insert">       for (unsigned int i=0;i&lt;maxPointSources; ++i)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       coronaBuffer</span>      = <span class="delete">renderer-&gt;createVertexBuffer&lt;ColoredTexturedVert</span></td><td> </td><td class="rblock"><span class="insert">       {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ex&gt;(PrimitiveType_Triangles);</span></td><td> </td><td class="rblock"><span class="insert">               static const unsigned char texElems[] = {0, 0, 255, 0, 255, </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">255, 0, 0, 255, 255, 0, 255};</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               unsigned char* elem = &amp;textureCoordArray[i*6*2];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               memcpy(elem, texElems, 12);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">StelSkyDrawer::~StelSkyDrawer()</td><td> </td><td class="right">StelSkyDrawer::~StelSkyDrawer()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">if(NULL != starPointBuffer)  {delete starPointBuffer;}</span></td><td> </td><td class="rblock">       <span class="insert">delete[] vertexArray;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != starSpriteBuffer) {delete starSpriteBuffer;}</span></td><td> </td><td class="rblock"><span class="insert">       vertexArray = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != bigHaloBuffer)    {delete bigHaloBuffer;}</span></td><td> </td><td class="rblock"><span class="insert">       delete[] textureCoordArray;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != sunHaloBuffer)    {delete sunHaloBuffer;}</span></td><td> </td><td class="rblock"><span class="insert">       textureCoordArray = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != coronaBuffer)     {delete coronaBuffer;}</span></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != texBigHalo)       {delete texBigHalo;}</span></td><td> </td><td class="rblock"><span class="insert">       delete starShaderProgram;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != texSunHalo)       {delete texSunHalo;}</span></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != texHalo)          {delete texHalo;}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != texCorona)        {delete texCorona;}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Init parameters from config file</td><td> </td><td class="right">// Init parameters from config file</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void StelSkyDrawer::init()</td><td> </td><td class="right">void StelSkyDrawer::init()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Load star texture no mipmap:</td><td> </td><td class="right">       // Load star texture no mipmap:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       texHalo    = <span class="delete">renderer-&gt;createTexture("textures/star16x16.png");</span></td><td> </td><td class="rblock">       texHalo = <span class="insert">StelApp::getInstance().getTextureManager().createTexture(S</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       texBigHalo = <span class="delete">renderer-&gt;createTexture("textures/haloLune.png");</span></td><td> </td><td class="rblock"><span class="insert">telFileMgr::getInstallationDir()+"/textures/star16x16.png");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       texSunHalo = <span class="delete">renderer-&gt;createTexture("textures/halo.png");</span></td><td> </td><td class="rblock">       texBigHalo = <span class="insert">StelApp::getInstance().getTextureManager().createTextur</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       texCorona</span>  = <span class="delete">renderer-&gt;createTexture("textures/corona.png");</span></td><td> </td><td class="rblock"><span class="insert">e(StelFileMgr::getInstallationDir()+"/textures/haloLune.png");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       texSunHalo = <span class="insert">StelApp::getInstance().getTextureManager().createTextur</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e(StelFileMgr::getInstallationDir()+"/textures/halo.png");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Create shader program</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       QOpenGLShader vshader(QOpenGLShader::Vertex);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       const char *vsrc</span> =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               <span class="insert">"attribute mediump vec2 pos;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "attribute mediump vec2 texCoord;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "attribute mediump vec3 color;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "uniform mediump mat4 projectionMatrix;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "varying mediump vec2 texc;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "varying mediump vec3 outColor;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "void main(void)\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "{\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "    gl_Position = projectionMatrix * vec4(pos.x, pos.y, 0, </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">1);\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "    texc = texCoord;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "    outColor = color;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "}\n";</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vshader.compileSourceCode(vsrc);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (!vshader.log().isEmpty()) { qWarning() &lt;&lt; "StelSkyDrawer::init()</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">: Warnings while compiling vshader: " &lt;&lt; vshader.log(); }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       QOpenGLShader fshader(QOpenGLShader::Fragment);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       const char *fsrc =</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "varying mediump vec2 texc;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "varying mediump vec3 outColor;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "uniform sampler2D tex;\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "void main(void)\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "{\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "    gl_FragColor = texture2D(tex, texc)*vec4(outColor, 1.);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">\n"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               "}\n";</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       fshader.compileSourceCode(fsrc);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (!fshader.log().isEmpty()) { qWarning() &lt;&lt; "StelSkyDrawer::init()</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">: Warnings while compiling fshader: " &lt;&lt; fshader.log(); }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram = new QOpenGLShaderProgram(QOpenGLContext::current</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">Context());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;addShader(&amp;vshader);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;addShader(&amp;fshader);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       StelPainter::linkProg(starShaderProgram, "starShader");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars.projectionMatrix = starShaderProgram-&gt;uniformLocation</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">("projectionMatrix");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars.texCoord = starShaderProgram-&gt;attributeLocation("texC</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">oord");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars.pos = starShaderProgram-&gt;attributeLocation("pos");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars.color = starShaderProgram-&gt;attributeLocation("color")</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderVars.texture = starShaderProgram-&gt;uniformLocation("tex");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       update(0);</td><td> </td><td class="right">       update(0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void StelSkyDrawer::update(double)</td><td> </td><td class="right">void StelSkyDrawer::update(double)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float fov = core-&gt;getMovementMgr()-&gt;getCurrentFov();</td><td> </td><td class="right">       float fov = core-&gt;getMovementMgr()-&gt;getCurrentFov();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (fov &gt; maxAdaptFov)</td><td> </td><td class="right">       if (fov &gt; maxAdaptFov)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               fov = maxAdaptFov;</td><td> </td><td class="right">               fov = maxAdaptFov;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 217</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 242</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // update limit luminance</td><td> </td><td class="right">       // update limit luminance</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       limitLuminance = computeLimitLuminance();</td><td> </td><td class="right">       limitLuminance = computeLimitLuminance();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Compute the current limit magnitude by dichotomy</td><td> </td><td class="right">// Compute the current limit magnitude by dichotomy</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">float StelSkyDrawer::computeLimitMagnitude() const</td><td> </td><td class="right">float StelSkyDrawer::computeLimitMagnitude() const</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float a=-26.f;</td><td> </td><td class="right">       float a=-26.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float b=30.f;</td><td> </td><td class="right">       float b=30.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">float rcmag[2]</span>;</td><td> </td><td class="rblock">       <span class="insert">RCMag rcmag</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float lim = 0.f;</td><td> </td><td class="right">       float lim = 0.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int safety=0;</td><td> </td><td class="right">       int safety=0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       while (std::fabs(lim-a)&gt;0.05)</td><td> </td><td class="rblock">       while (std::fabs(lim-a)&gt;0.05<span class="insert">f</span>)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               computeRCMag(lim, <span class="delete">rcmag);</span></td><td> </td><td class="rblock">               computeRCMag(lim, <span class="insert">&amp;rcmag);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if <span class="delete">(rcmag[0]&lt;=0.f)</span></td><td> </td><td class="rblock">               if <span class="insert">(rcmag.radius&lt;=0.f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       float tmp = lim;</td><td> </td><td class="right">                       float tmp = lim;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       lim=(a+lim)*0.5;</td><td> </td><td class="right">                       lim=(a+lim)*0.5;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       b=tmp;</td><td> </td><td class="right">                       b=tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               else</td><td> </td><td class="right">               else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       float tmp = lim;</td><td> </td><td class="right">                       float tmp = lim;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       lim=(b+lim)*0.5;</td><td> </td><td class="right">                       lim=(b+lim)*0.5;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       a=tmp;</td><td> </td><td class="right">                       a=tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 292</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 317</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">float StelSkyDrawer::pointSourceLuminanceToMag(float lum)</td><td> </td><td class="right">float StelSkyDrawer::pointSourceLuminanceToMag(float lum)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (std::log(lum) - lnfovFactor)/-0.92103f - 12.12331f;</td><td> </td><td class="right">       return (std::log(lum) - lnfovFactor)/-0.92103f - 12.12331f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Compute the luminance for an extended source with the given surface brig
htness in Vmag/arcmin^2</td><td> </td><td class="right">// Compute the luminance for an extended source with the given surface brig
htness in Vmag/arcmin^2</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">float StelSkyDrawer::surfacebrightnessToLuminance(float sb)</td><td> </td><td class="right">float StelSkyDrawer::surfacebrightnessToLuminance(float sb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       return 2.<span class="delete">*2025000.f*std::exp(-0.92103f*(sb + 12.12331f))/(1./60.*1./
60.</span>);</td><td> </td><td class="rblock">       return 2.<span class="insert">f*2025000.f*std::exp(-0.92103f*(sb + 12.12331f))/(1.f/60.f*
1.f/60.f</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Compute the surface brightness from the luminance of an extended source</td><td> </td><td class="right">// Compute the surface brightness from the luminance of an extended source</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">float StelSkyDrawer::luminanceToSurfacebrightness(float lum)</td><td> </td><td class="right">float StelSkyDrawer::luminanceToSurfacebrightness(float lum)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       return std::log(lum*(1.<span class="delete">/60.*1./60.)/(2.*2025000.f))/-0.92103f - 12.1
</span>2331f;</td><td> </td><td class="rblock">       return std::log(lum*(1.<span class="insert">f/60.f*1.f/60.f)/(2.f*2025000.f))/-0.92103f -
 12.1</span>2331f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Compute RMag and CMag from magnitude for a point source.</td><td> </td><td class="right">// Compute RMag and CMag from magnitude for a point source.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">bool StelSkyDrawer::computeRCMag(float mag, <span class="delete">float rcMag[2]</span>) const</td><td> </td><td class="rblock">bool StelSkyDrawer::computeRCMag(float mag, <span class="insert">RCMag* rcMag</span>) const</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">rcMag[0]</span> = <span class="delete">eye-&gt;adaptLuminanceScaledLn(pointSourceMagToLnLuminance(m</span></td><td> </td><td class="rblock">       <span class="insert">rcMag-&gt;radius</span> = <span class="insert">eye-&gt;adaptLuminanceScaledLn(pointSourceMagToLnLumina</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ag),</span> starRelativeScale*1.40f/2.f);</td><td> </td><td class="rblock"><span class="insert">nce(mag),</span> starRelativeScale*1.40f/2.f);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">rcMag[0]*=starLinearScale;</span></td><td> </td><td class="rblock">       <span class="insert">rcMag-&gt;radius *=starLinearScale;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Use now statically min_rmag = 0.5, because higher and too small v
alues look bad</td><td> </td><td class="right">       // Use now statically min_rmag = 0.5, because higher and too small v
alues look bad</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (rcMag<span class="delete">[0] &lt; 0.5</span>f)</td><td> </td><td class="rblock">       if (rcMag<span class="insert">-&gt;radius &lt; 0.3</span>f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">rcMag[0]</span> = <span class="delete">rcMag[1]</span> = 0.f;</td><td> </td><td class="rblock">               <span class="insert">rcMag-&gt;radius</span> = <span class="insert">0.f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               rcMag-&gt;luminance</span> = 0.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return false;</td><td> </td><td class="right">               return false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // if size of star is too small (blink) we put its size to 1.2 --&gt; n
o more blink</td><td> </td><td class="right">       // if size of star is too small (blink) we put its size to 1.2 --&gt; n
o more blink</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // And we compensate the difference of brighteness with cmag</td><td> </td><td class="right">       // And we compensate the difference of brighteness with cmag</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (rcMag<span class="delete">[0]</span>&lt;1.2f)</td><td> </td><td class="rblock">       if (rcMag<span class="insert">-&gt;radius</span>&lt;1.2f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">rcMag[1] = rcMag[0]</span> * <span class="delete">rcMag[0]</span> / <span class="delete">1.44f;</span></td><td> </td><td class="rblock">               <span class="insert">rcMag-&gt;luminance= rcMag-&gt;radius</span> * <span class="insert">rcMag-&gt;radius * rcMag-&gt;rad</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if <span class="delete">(rcMag[1]</span> &lt; <span class="delete">0.07f)</span></td><td> </td><td class="rblock"><span class="insert">ius</span> / <span class="insert">1.728f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               if <span class="insert">(rcMag-&gt;luminance</span> &lt; <span class="insert">0.05f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       rcMag<span class="delete">[0] = rcMag[1]</span> = 0.f;</td><td> </td><td class="rblock">                       rcMag<span class="insert">-&gt;radius = rcMag-&gt;luminance</span> = 0.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return false;</td><td> </td><td class="right">                       return false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               rcMag<span class="delete">[0]</span> = 1.2f;</td><td> </td><td class="rblock">               rcMag<span class="insert">-&gt;radius</span> = 1.2f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       else</td><td> </td><td class="right">       else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               // cmag:</td><td> </td><td class="right">               // cmag:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">rcMag[1]</span> = 1.0f;</td><td> </td><td class="rblock">               <span class="insert">rcMag-&gt;luminance</span> = 1.0f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if <span class="delete">(rcMag[0]&gt;MAX_LINEAR_RADIUS)</span></td><td> </td><td class="rblock">               if <span class="insert">(rcMag-&gt;radius&gt;MAX_LINEAR_RADIUS)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       rcMag<span class="delete">[0]=MAX_LINEAR_RADIUS+std::sqrt(1.f+rcMag[0]-MA
</span>X_LINEAR_RADIUS)-1.f;</td><td> </td><td class="rblock">                       rcMag<span class="insert">-&gt;radius=MAX_LINEAR_RADIUS+std::sqrt(1.f+rcMag-
&gt;radius-MA</span>X_LINEAR_RADIUS)-1.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return true;</td><td> </td><td class="right">       return true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void StelSkyDrawer::preDrawPointSource()</td><td> </td><td class="rblock">void StelSkyDrawer::preDrawPointSource(<span class="insert">StelPainter* p</span>)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">Q_ASSERT_X(!drawing, Q_FUNC_INFO,</span></td><td> </td><td class="rblock">       <span class="insert">Q_ASSERT(p);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                  "Attempting to start drawing point sources when it is alr</span></td><td> </td><td class="rblock"><span class="insert">       Q_ASSERT(nbPointSources==0);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">eady started");</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">drawing = true;</span></td><td> </td><td class="rblock">       // <span class="insert">Blending</span> is <span class="insert">really important. Otherwise faint</span> stars <span class="insert">in</span> the <span class="insert">vicini</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"><span class="insert">ty</span> of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock">       // <span class="insert">bright star will cause tiny black squares on</span> the <span class="insert">bright star, e.g</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">// <span class="delete">Helper function that sets Add blend mode, then draws and clears a vertex</span></td><td> </td><td class="rblock"><span class="insert">. see Procyon.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> buffer.</span></td><td> </td><td class="rblock"><span class="insert">       glEnable(GL_BLEND);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//</span></td><td> </td><td class="rblock"><span class="insert">       glBlendFunc(GL_ONE, GL_ONE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">// The buffer</span> is <span class="delete">cleared since we re-add the</span> stars <span class="delete">on each frame.</span></td><td> </td><td class="rblock"><span class="insert">       p-&gt;enableTexture2d(true);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">template&lt;class VB&gt;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">void drawStars(StelTextureNew* texture, VB* vertices, StelRenderer* rendere</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">r, StelProjectorP projector)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(NULL != texture){texture-&gt;bind();}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       renderer-&gt;setBlendMode(BlendMode_Add);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       vertices-&gt;lock();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // Vertices are already projected, so we use</span> the <span class="delete">dontProject</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // argument</span> of <span class="delete">drawVertexBuffer.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       //</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">// This is a hack - it would be better to refactor StelSkyDrawer,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // ZoneArray, etc, so projection gets done by</span> the <span class="delete">projector</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // during drawing like elsewhere.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       renderer-&gt;drawVertexBuffer(vertices, NULL, projector, true);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       vertices-&gt;unlock();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       vertices-&gt;clear();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Finalize the drawing of point sources</td><td> </td><td class="right">// Finalize the drawing of point sources</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void StelSkyDrawer::postDrawPointSource(StelP<span class="delete">rojectorP projecto</span>r)</td><td> </td><td class="rblock">void StelSkyDrawer::postDrawPointSource(StelP<span class="insert">ainter* sPainte</span>r)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">StelRendererStatistics&amp; stats = renderer-&gt;getStatistics();</span></td><td> </td><td class="rblock">       <span class="insert">Q_ASSERT(sPainter);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(!statisticsInitialized)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               bigHaloStatID = stats.addStatistic("big_halo_draws", Statist</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">icSwapMode_SetToZero);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               sunHaloStatID = stats.addStatistic("sun_halo_draws", Statist</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">icSwapMode_SetToZero);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               starStatID    = stats.addStatistic("star_draws",     Statist</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">icSwapMode_SetToZero);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               statisticsInitialized = true;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(bigHaloBuffer-&gt;length() &gt; 0)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               drawStars(texBigHalo, bigHaloBuffer, renderer, projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               stats[bigHaloStatID] += 1.0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(sunHaloBuffer-&gt;length() &gt; 0)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               drawStars(texSunHalo, sunHaloBuffer, renderer, projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               stats[sunHaloStatID] += 1.0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if(drawStarsAsPoints &amp;&amp; starPointBuffer-&gt;length() &gt; 0)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               stats[starStatID] += 1.0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               drawStars(NULL, starPointBuffer, renderer, projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       else if(starSpriteBuffer-&gt;length() &gt; 0)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               stats[starStatID] += 1.0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               drawStars(texHalo, starSpriteBuffer, renderer, projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       drawing = false;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//Helper function that adds the halo of a star/other point source to given </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">vertex buffer.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//The template parameter is only used so we don't need to write ColoredText</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">uredVertex</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//every time, this function is only meant to be used from drawPointSource.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">template&lt;class V&gt;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">static void addStar(StelVertexBuffer&lt;V&gt;* vertices,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                    const float x, const float y,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                    const float radius, const Vec3f&amp; color)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // 1 triangle around the star sprite. We use the fact</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // that edges of the halo textures are transparent and</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // the clamp to edge draw mode. With that, we can draw 1</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // larger triangle around the sprite quad instead of drawing</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // the quad as 2 triangles.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       const <span class="delete">float yBase</span>  = <span class="delete">y - radius;</span></td><td> </td><td class="rblock">       <span class="insert">if (nbPointSources==0)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       const <span class="delete">float yTop   = y + radius * 2.6666666;</span></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       const float xLeft  = x - radius * 2.3333333;</span></td><td> </td><td class="rblock"><span class="insert">       texHalo-&gt;bind();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       const float xRight = x + radius * 2.3333333;</span></td><td> </td><td class="rblock"><span class="insert">       sPainter-&gt;enableTexture2d(true);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       glBlendFunc(GL_ONE, GL_ONE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       glEnable(GL_BLEND);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       const <span class="insert">Mat4f&amp; m</span> = <span class="insert">sPainter-&gt;getProjector()-&gt;getProjectionMatrix();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       const <span class="insert">QMatrix4x4 qMat(m[0], m[4], m[8], m[12], m[1], m[5], m[9], m[1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">3], m[2], m[6], m[10], m[14], m[3], m[7], m[11], m[15]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       Q_ASSERT(sizeof(StarVertex)==12);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;bind();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;setAttributeArray(starShaderVars.pos, GL_FLOAT, (</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">GLfloat*)vertexArray, 2, 12);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;enableAttributeArray(starShaderVars.pos);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;setAttributeArray(starShaderVars.color, GL_UNSIGN</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ED_BYTE, (GLubyte*)&amp;(vertexArray[0].color), 3, 12);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;enableAttributeArray(starShaderVars.color);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;setUniformValue(starShaderVars.projectionMatrix, </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qMat);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;setAttributeArray(starShaderVars.texCoord, GL_UNS</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">IGNED_BYTE, (GLubyte*)textureCoordArray, 2, 0);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;enableAttributeArray(starShaderVars.texCoord);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       glDrawArrays(GL_TRIANGLES, 0, nbPointSources*6);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;disableAttributeArray(starShaderVars.pos);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;disableAttributeArray(starShaderVars.color);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;disableAttributeArray(starShaderVars.texCoord);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starShaderProgram-&gt;release();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">vertices-&gt;addVertex(V(Vec2f(xLeft,  yBase), color, Vec2f(-0.6666666f</span></td><td> </td><td class="rblock">       <span class="insert">nbPointSources = 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">, 0.0f)));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       vertices-&gt;addVertex(V(Vec2f(xRight, yBase), color, Vec2f(1.6666666f,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  0.0f)));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       vertices-&gt;addVertex(V(Vec2f(x,      yTop),  color, Vec2f(0.5f,      </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  1.83333333f)));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Draw a point source halo.</td><td> </td><td class="right">// Draw a point source halo.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">void StelSkyDrawer::drawPointSource</span></td><td> </td><td class="rblock"><span class="insert">bool StelSkyDrawer::drawPointSource(StelPainter* sPainter, const</span> Vec3f&amp; <span class="insert">v,</span> </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       (const</span> Vec3f&amp; <span class="delete">win,</span> const <span class="delete">float rcMag[2],</span> const Vec3f&amp; <span class="delete">bcolor)</span></td><td> </td><td class="rblock">const <span class="insert">RCMag&amp; rcMag,</span> const Vec3f&amp; <span class="insert">color, bool checkInScreen)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">Q_ASSERT_X(drawing, Q_FUNC_INFO,</span></td><td> </td><td class="rblock">       <span class="insert">Q_ASSERT(sPainter);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                  "Attempting to draw a point source without calling preDra</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">wPointSource first.");</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       const float radius    = rcMag[0];</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       const float luminance = rcMag[1];</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">const Vec3f color = StelApp::getInstance().getVisionModeNight()</span></td><td> </td><td class="rblock">       <span class="insert">if (rcMag.radius&lt;=0.f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                         ? Vec3f(bcolor[0], 0, 0) : bcolor;</span></td><td> </td><td class="rblock"><span class="insert">               return false;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // Random coef for star twinkling</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       const float tw = (flagStarTwinkle &amp;&amp; flagHasAtmosphere)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                        ? (1.0f - twinkleAmount * rand() / RAND_MAX) * lumi</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">nance</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                        : luminance;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       const float <span class="delete">x</span> = <span class="delete">win[0];</span></td><td> </td><td class="rblock">       <span class="insert">Vec3f win;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       const float <span class="delete">y</span> = <span class="delete">win[1];</span></td><td> </td><td class="rblock"><span class="insert">       if (!(checkInScreen ? sPainter-&gt;getProjector()-&gt;projectCheck(v, win)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> : sPainter-&gt;getProjector()-&gt;project(v, win)))</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return false;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       const float <span class="insert">radius</span> = <span class="insert">rcMag.radius;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Random coef for star twinkling</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       const float <span class="insert">tw</span> = <span class="insert">(flagStarTwinkle &amp;&amp; flagHasAtmosphere) ? (1.f-twink</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">leAmount*rand()/RAND_MAX)*rcMag.luminance : rcMag.luminance;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // If the rmag is big, draw a big halo</td><td> </td><td class="right">       // If the rmag is big, draw a big halo</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (radius<span class="delete"> &gt; MAX_LINEAR_RADIUS + 5.0</span>f)</td><td> </td><td class="rblock">       if (radius<span class="insert">&gt;MAX_LINEAR_RADIUS+5.</span>f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">const</span> float cmag = <span class="delete">qMin(1.0f, qMin(luminance, (radius - MAX_</span></td><td> </td><td class="rblock">               float cmag = <span class="insert">qMin(rcMag.luminance,(float)(radius-(MAX_LINEAR</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">LINEAR_RADIUS + 5.0f) / 30.f));</span></td><td> </td><td class="rblock"><span class="insert">_RADIUS+5.f))/30.f);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               addStar(bigHaloBuffer, x, y, 150.0f, color * cmag);</span></td><td> </td><td class="rblock"><span class="insert">               float rmag = 150.f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       }</td><td> </td><td class="rblock"><span class="insert">               if (cmag&gt;1.f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       cmag = 1.f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               texBigHalo-&gt;bind();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               sPainter-&gt;enableTexture2d(true);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               glBlendFunc(GL_ONE, GL_ONE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               glEnable(GL_BLEND);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               sPainter-&gt;setColor(color[0]*cmag, color[1]*cmag, color[2]*cm</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ag);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               sPainter-&gt;drawSprite2dModeNoDeviceScale(win[0], win[1], rmag</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">unsigned char starColor[3] = {0, 0, 0};</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starColor[0] = (unsigned char)std::min((int)(color[0]*tw*255+0.5f), </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">255);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starColor[1] = (unsigned char)std::min((int)(color[1]*tw*255+0.5f), </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">255);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       starColor[2] = (unsigned char)std::min((int)(color[2]*tw*255+0.5f), </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">255);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Store the drawing instructions in the vertex arrays</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       StarVertex* vx = &amp;(vertexArray[nbPointSources*6]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]-radius,win[1]-radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]+radius,win[1]-radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]+radius,win[1]+radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]-radius,win[1]-radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]+radius,win[1]+radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       vx-&gt;pos.set(win[0]-radius,win[1]+radius); memcpy(vx-&gt;color, starColo</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">r, 3); ++vx;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">(drawStarsAsPoints)</span></td><td> </td><td class="rblock">       <span class="insert">++nbPointSources;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if <span class="insert">(nbPointSources&gt;=maxPointSources)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">starPointBuffer-&gt;addVertex(ColoredVertex(Vec2f(x, y), color </span></td><td> </td><td class="rblock">               <span class="insert">// Flush the buffer (draw all buffered stars)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">* tw));</span></td><td> </td><td class="rblock"><span class="insert">               postDrawPointSource(sPainter);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">else</span></td><td> </td><td class="rblock">       <span class="insert">return true;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               addStar(starSpriteBuffer, x, y, radius, color * tw);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">// Draw's the sun's corona during a solar eclipse on earth.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">void StelSkyDrawer::drawSunCorona(StelProjectorP projector, const Vec3d &amp;v,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> float radius, float alpha)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">{</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       Vec3d win;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       projector-&gt;project(v, win);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       addStar(coronaBuffer, win[0], win[1], radius * 2, Vec3f(alpha, alpha</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">, alpha));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       drawStars(texCorona, coronaBuffer, renderer, projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Terminate drawing of a 3D model, draw the halo</td><td> </td><td class="right">// Terminate drawing of a 3D model, draw the halo</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">StelSkyDrawer::postDrawSky3dModel</span></td><td> </td><td class="rblock">void <span class="insert">StelSkyDrawer::postDrawSky3dModel(StelPainter* painter,</span> const <span class="insert">Vec3f&amp; v</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       (StelProjectorP projector,</span> const <span class="delete">Vec3d&amp; v,</span> float illuminatedArea,</td><td> </td><td class="rblock"><span class="insert">,</span> float illuminatedArea, float mag, const Vec3f&amp; color)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        float mag, const Vec3f&amp; color)</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">// GZ: Only draw if we did not clamp this object away.</span></td><td> </td><td class="rblock">       const float pixPerRad = <span class="insert">painter-&gt;getProjector()-&gt;getPixelPerRadAtCen</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if (flagStarMagnitudeLimit &amp;&amp; (mag &gt; customStarMagLimit)) return;</span></td><td> </td><td class="rblock"><span class="insert">ter();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       const float pixPerRad = <span class="delete">projector-&gt;getPixelPerRadAtCenter();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Assume a disk shape</td><td> </td><td class="right">       // Assume a disk shape</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float pixRadius = std::sqrt(illuminatedArea/(60.*60.)*M_PI/180.*M_PI
/180.*(pixPerRad*pixPerRad))/M_PI;</td><td> </td><td class="right">       float pixRadius = std::sqrt(illuminatedArea/(60.*60.)*M_PI/180.*M_PI
/180.*(pixPerRad*pixPerRad))/M_PI;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       bool noStarHalo = false;</td><td> </td><td class="right">       bool noStarHalo = false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (mag&lt;-15.f)</td><td> </td><td class="right">       if (mag&lt;-15.f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">const</span> float rmag = big3dModelHaloRadius*(mag+15.f)/-11.f;</td><td> </td><td class="rblock">               <span class="insert">// Sun, halo size varies in function of the magnitude becaus</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e sun as seen from pluto should look dimmer</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // as the sun as seen from earth</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               texSunHalo-&gt;bind();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               glEnable(GL_BLEND);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               glBlendFunc(GL_ONE, GL_ONE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               painter-&gt;enableTexture2d(true);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               float rmag = big3dModelHaloRadius*(mag+15.f)/-11.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               float cmag = 1.f;</td><td> </td><td class="right">               float cmag = 1.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if <span class="delete">(rmag&lt;pixRadius*3.f+100.0f)</span></td><td> </td><td class="rblock">               if <span class="insert">(rmag&lt;pixRadius*3.f+100.)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       cmag = qMax(0.f, 1.f-(pixRadius*3.f+100-rmag)/100);</td><td> </td><td class="right">                       cmag = qMax(0.f, 1.f-(pixRadius*3.f+100-rmag)/100);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">}</span></td><td> </td><td class="rblock">               <span class="insert">Vec3f</span> win;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               Vec3d</span> win;</td><td> </td><td class="rblock">               <span class="insert">painter-&gt;getProjector()-&gt;project(v,</span> win);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">projector-&gt;project(v,</span> win);</td><td> </td><td class="rblock">               <span class="insert">painter-&gt;setColor(color[0]*cmag, color[1]*cmag, color[2]*cma</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">Vec3f c = color;</span></td><td> </td><td class="rblock"><span class="insert">g);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               if (StelApp::getInstance().getVisionModeNight())</span></td><td> </td><td class="rblock"><span class="insert">               painter-&gt;drawSprite2dModeNoDeviceScale(win[0],</span> win[1], <span class="insert">rmag)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       c = StelUtils::getNightColor(c);</span></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               addStar(sunHaloBuffer, win[0],</span> win[1], <span class="delete">rmag, c * cmag);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               noStarHalo = true;</td><td> </td><td class="right">               noStarHalo = true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Now draw the halo according the object brightness</td><td> </td><td class="right">       // Now draw the halo according the object brightness</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       bool save = flagStarTwinkle;</td><td> </td><td class="right">       bool save = flagStarTwinkle;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       flagStarTwinkle = false;</td><td> </td><td class="right">       flagStarTwinkle = false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">float rcm[2];</span></td><td> </td><td class="rblock">       <span class="insert">RCMag rcm;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       computeRCMag(mag, <span class="delete">rcm);</span></td><td> </td><td class="rblock">       computeRCMag(mag, <span class="insert">&amp;rcm);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // We now have the radius and luminosity of the small halo</td><td> </td><td class="right">       // We now have the radius and luminosity of the small halo</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // If the disk of the planet is big enough to be visible, we should 
adjust the eye adaptation luminance</td><td> </td><td class="right">       // If the disk of the planet is big enough to be visible, we should 
adjust the eye adaptation luminance</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // so that the radius of the halo is small enough to be not visible 
(so that we see the disk)</td><td> </td><td class="right">       // so that the radius of the halo is small enough to be not visible 
(so that we see the disk)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float tStart = 2.f;</td><td> </td><td class="right">       float tStart = 2.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float tStop = 6.f;</td><td> </td><td class="right">       float tStop = 6.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       bool truncated=false;</td><td> </td><td class="right">       bool truncated=false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float maxHaloRadius = qMax(tStart*3., pixRadius*3.);</td><td> </td><td class="right">       float maxHaloRadius = qMax(tStart*3., pixRadius*3.);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (rcm<span class="delete">[0]</span>&gt;maxHaloRadius)</td><td> </td><td class="rblock">       if (rcm<span class="insert">.radius</span>&gt;maxHaloRadius)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               truncated = true;</td><td> </td><td class="right">               truncated = true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               rcm<span class="delete">[0]=maxHaloRadius+std::sqrt(rcm[0]-maxHaloRadius)</span>;</td><td> </td><td class="rblock">               rcm<span class="insert">.radius=maxHaloRadius+std::sqrt(rcm.radius-maxHaloRadius)
</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Fade the halo away when the disk is too big</td><td> </td><td class="right">       // Fade the halo away when the disk is too big</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pixRadius&gt;=tStop)</td><td> </td><td class="right">       if (pixRadius&gt;=tStop)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               rcm<span class="delete">[1]</span>=0.f;</td><td> </td><td class="rblock">               rcm<span class="insert">.luminance</span>=0.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pixRadius&gt;tStart &amp;&amp; pixRadius&lt;tStop)</td><td> </td><td class="right">       if (pixRadius&gt;tStart &amp;&amp; pixRadius&lt;tStop)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               rcm<span class="delete">[1]</span>=(tStop-pixRadius)/(tStop-tStart);</td><td> </td><td class="rblock">               rcm<span class="insert">.luminance</span>=(tStop-pixRadius)/(tStop-tStart);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (truncated &amp;&amp; flagLuminanceAdaptation)</td><td> </td><td class="right">       if (truncated &amp;&amp; flagLuminanceAdaptation)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               float wl = findWorldLumForMag(mag, rcm<span class="delete">[0]</span>);</td><td> </td><td class="rblock">               float wl = findWorldLumForMag(mag, rcm<span class="insert">.radius</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (wl&gt;0)</td><td> </td><td class="right">               if (wl&gt;0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       const float f = core-&gt;getMovementMgr()-&gt;getCurrentFo
v();</td><td> </td><td class="right">                       const float f = core-&gt;getMovementMgr()-&gt;getCurrentFo
v();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       reportLuminanceInFov(qMin(700.f, qMin(wl/50, (60.f*6
0.f)/(f*f)*6.f)));</td><td> </td><td class="right">                       reportLuminanceInFov(qMin(700.f, qMin(wl/50, (60.f*6
0.f)/(f*f)*6.f)));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (!noStarHalo)</td><td> </td><td class="right">       if (!noStarHalo)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">preDrawPointSource();</span></td><td> </td><td class="rblock">               <span class="insert">preDrawPointSource(painter);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               const Vec3f vf(v[0], v[1], v[2]);</span></td><td> </td><td class="rblock"><span class="insert">               drawPointSource(painter, v,</span> rcm, color);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               Vec3f win;</span></td><td> </td><td class="rblock">               <span class="insert">postDrawPointSource(painter);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               if(pointSourceVisible(&amp;(*projector), vf, rcm, false, win))</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       drawPointSource(win,</span> rcm, color);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               postDrawPointSource(projector);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       flagStarTwinkle=save;</td><td> </td><td class="right">       flagStarTwinkle=save;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">float StelSkyDrawer::findWorldLumForMag(float mag, float targetRadius)</td><td> </td><td class="right">float StelSkyDrawer::findWorldLumForMag(float mag, float targetRadius)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       const float saveLum = eye-&gt;getWorldAdaptationLuminance();       // s
ave</td><td> </td><td class="right">       const float saveLum = eye-&gt;getWorldAdaptationLuminance();       // s
ave</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Compute the luminance by dichotomy</td><td> </td><td class="right">       // Compute the luminance by dichotomy</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float a=0.001f;</td><td> </td><td class="right">       float a=0.001f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float b=500000.f;</td><td> </td><td class="right">       float b=500000.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">float rcmag[2];</span></td><td> </td><td class="rblock">       <span class="insert">RCMag rcmag;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       rcmag[0]=-99;</span></td><td> </td><td class="rblock"><span class="insert">       rcmag.radius=-99;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float curLum = 500.f;</td><td> </td><td class="right">       float curLum = 500.f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int safety=0;</td><td> </td><td class="right">       int safety=0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       while (std::fabs(rcmag<span class="delete">[0]</span>-targetRadius)&gt;0.1)</td><td> </td><td class="rblock">       while (std::fabs(rcmag<span class="insert">.radius</span>-targetRadius)&gt;0.1)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               eye-&gt;setWorldAdaptationLuminance(curLum);</td><td> </td><td class="right">               eye-&gt;setWorldAdaptationLuminance(curLum);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0070" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               computeRCMag(mag, <span class="delete">rcmag);</span></td><td> </td><td class="rblock">               computeRCMag(mag, <span class="insert">&amp;rcmag);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if <span class="delete">(rcmag[0]&lt;=targetRadius)</span></td><td> </td><td class="rblock">               if <span class="insert">(rcmag.radius&lt;=targetRadius)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       float tmp = curLum;</td><td> </td><td class="right">                       float tmp = curLum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       curLum=(a+curLum)/2;</td><td> </td><td class="right">                       curLum=(a+curLum)/2;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       b=tmp;</td><td> </td><td class="right">                       b=tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               else</td><td> </td><td class="right">               else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       float tmp = curLum;</td><td> </td><td class="right">                       float tmp = curLum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       curLum=(b+curLum)/2;</td><td> </td><td class="right">                       curLum=(b+curLum)/2;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       a=tmp;</td><td> </td><td class="right">                       a=tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 636</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 621</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void StelSkyDrawer::preDraw()</td><td> </td><td class="right">void StelSkyDrawer::preDraw()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       eye-&gt;setWorldAdaptationLuminance(maxLum);</td><td> </td><td class="right">       eye-&gt;setWorldAdaptationLuminance(maxLum);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Re-initialize for next stage</td><td> </td><td class="right">       // Re-initialize for next stage</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       oldLum = maxLum;</td><td> </td><td class="right">       oldLum = maxLum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       maxLum = 0;</td><td> </td><td class="right">       maxLum = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0071" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">// Set the parameters so that the stars disap<span class="delete">ear at about the limit given b
</span>y the bortle scale</td><td> </td><td class="rblock">// Set the parameters so that the stars disap<span class="insert">pear at about the limit given 
b</span>y the bortle scale</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// See http://en.wikipedia.org/wiki/Bortle_Dark-Sky_Scale</td><td> </td><td class="right">// See http://en.wikipedia.org/wiki/Bortle_Dark-Sky_Scale</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0072" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void StelSkyDrawer::setBortleScale(int bIndex)</td><td> </td><td class="rblock">void StelSkyDrawer::setBortleScale<span class="insert">Index</span>(int bIndex)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Associate the Bortle index (1 to 9) to inScale value</td><td> </td><td class="right">       // Associate the Bortle index (1 to 9) to inScale value</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (bIndex&lt;1)</td><td> </td><td class="right">       if (bIndex&lt;1)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0073" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qWarning() &lt;&lt; "WAR<span class="delete">ING: Bortle scale index range is [1;9], gi
</span>ven" &lt;&lt; bIndex;</td><td> </td><td class="rblock">               qWarning() &lt;&lt; "WAR<span class="insert">NING: Bortle scale index range is [1;9], g
i</span>ven" &lt;&lt; bIndex;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               bIndex = 1;</td><td> </td><td class="right">               bIndex = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (bIndex&gt;9)</td><td> </td><td class="right">       if (bIndex&gt;9)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0074" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qWarning() &lt;&lt; "WAR<span class="delete">ING: Bortle scale index range is [1;9], gi
</span>ven" &lt;&lt; bIndex;</td><td> </td><td class="rblock">               qWarning() &lt;&lt; "WAR<span class="insert">NING: Bortle scale index range is [1;9], g
i</span>ven" &lt;&lt; bIndex;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               bIndex = 9;</td><td> </td><td class="right">               bIndex = 9;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       bortleScaleIndex = bIndex;</td><td> </td><td class="right">       bortleScaleIndex = bIndex;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // GZ: I moved this block to update()</td><td> </td><td class="right">       // GZ: I moved this block to update()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // These value have been calibrated by hand, looking at the faintest
 star in stellarium at around 40 deg FOV</td><td> </td><td class="right">       // These value have been calibrated by hand, looking at the faintest
 star in stellarium at around 40 deg FOV</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // They should roughly match the scale described at http://en.wikipe
dia.org/wiki/Bortle_Dark-Sky_Scale</td><td> </td><td class="right">       // They should roughly match the scale described at http://en.wikipe
dia.org/wiki/Bortle_Dark-Sky_Scale</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // static const float bortleToInScale[9] = {2.45, 1.55, 1.0, 0.63, 0
.40, 0.24, 0.23, 0.145, 0.09};</td><td> </td><td class="right">       // static const float bortleToInScale[9] = {2.45, 1.55, 1.0, 0.63, 0
.40, 0.24, 0.23, 0.145, 0.09};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // setInputScale(bortleToInScale[bIndex-1]);</td><td> </td><td class="right">       // setInputScale(bortleToInScale[bIndex-1]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 74 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>281 lines changed or deleted</i></th><th><i> </i></th><th><i>286 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
