<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux fomalhaut.local 3.13.0-45-generic #74-Ubuntu SMP Tue Jan 13 19:36:28 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 4.0.1 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.3 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 1.2.1 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: Comet.cpp - Comet.cpp</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;Comet.cpp&nbsp;</th><th> </th><th>&nbsp;Comet.cpp&nbsp;</th><th></th></tr> 
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Stellarium</td><td> </td><td class="right"> * Stellarium</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Copyright (C) 2010 Bogdan Marinov</td><td> </td><td class="right"> * Copyright (C) 2010 Bogdan Marinov</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * Copyright (C) 2014 Georg Zotti (Tails)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This program is free software; you can redistribute it and/or</td><td> </td><td class="right"> * This program is free software; you can redistribute it and/or</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * modify it under the terms of the GNU General Public License</td><td> </td><td class="right"> * modify it under the terms of the GNU General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * as published by the Free Software Foundation; either version 2</td><td> </td><td class="right"> * as published by the Free Software Foundation; either version 2</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * of the License, or (at your option) any later version.</td><td> </td><td class="right"> * of the License, or (at your option) any later version.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This program is distributed in the hope that it will be useful,</td><td> </td><td class="right"> * This program is distributed in the hope that it will be useful,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td> </td><td class="right"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td> </td><td class="right"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * GNU General Public License for more details.</td><td> </td><td class="right"> * GNU General Public License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 29</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 30</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "Comet.hpp"</td><td> </td><td class="right">#include "Comet.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "Orbit.hpp"</td><td> </td><td class="right">#include "Orbit.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelApp.hpp"</td><td> </td><td class="right">#include "StelApp.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelCore.hpp"</td><td> </td><td class="right">#include "StelCore.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelPainter.hpp"</td><td> </td><td class="right">#include "StelPainter.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelTexture.hpp"</td><td> </td><td class="right">#include "StelTexture.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelTextureMgr.hpp"</td><td> </td><td class="right">#include "StelTextureMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "StelToneReproducer.hpp"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelTranslator.hpp"</td><td> </td><td class="right">#include "StelTranslator.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelUtils.hpp"</td><td> </td><td class="right">#include "StelUtils.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelFileMgr.hpp"</td><td> </td><td class="right">#include "StelFileMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelMovementMgr.hpp"</td><td> </td><td class="right">#include "StelMovementMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "StelModuleMgr.hpp"</td><td> </td><td class="right">#include "StelModuleMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "LandscapeMgr.hpp"</td><td> </td><td class="right">#include "LandscapeMgr.hpp"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QRegExp&gt;</td><td> </td><td class="right">#include &lt;QRegExp&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;QDebug&gt;</td><td> </td><td class="right">#include &lt;QDebug&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 74</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 76</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 "",</td><td> </td><td class="right">                 "",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 coordFunc,</td><td> </td><td class="right">                 coordFunc,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 auserDataPtr,</td><td> </td><td class="right">                 auserDataPtr,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 osculatingFunc,</td><td> </td><td class="right">                 osculatingFunc,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 acloseOrbit,</td><td> </td><td class="right">                 acloseOrbit,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 hidden,</td><td> </td><td class="right">                 hidden,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 false, //No atmosphere</td><td> </td><td class="right">                 false, //No atmosphere</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 true, //halo</td><td> </td><td class="right">                 true, //halo</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                 pTypeStr),</td><td> </td><td class="right">                 pTypeStr),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         tailActive(false),</td><td> </td><td class="right">         tailActive(false),</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">         tailBright(false),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         dustTailWidthFactor(dustTailWidthFact),</td><td> </td><td class="right">         dustTailWidthFactor(dustTailWidthFact),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         dustTailLengthFactor(dustTailLengthFact),</td><td> </td><td class="right">         dustTailLengthFactor(dustTailLengthFact),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         dustTailBrightnessFactor(dustTailBrightnessFact)</td><td> </td><td class="right">         dustTailBrightnessFactor(dustTailBrightnessFact)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       texMapName = atexMapName;</td><td> </td><td class="right">       texMapName = atexMapName;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       lastOrbitJD =0;</td><td> </td><td class="right">       lastOrbitJD =0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       deltaJD = StelCore::JD_SECOND;</td><td> </td><td class="right">       deltaJD = StelCore::JD_SECOND;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       deltaJDtail=15.0*StelCore::JD_MINUTE; // update tail geometry every 
15 minutes only</td><td> </td><td class="right">       deltaJDtail=15.0*StelCore::JD_MINUTE; // update tail geometry every 
15 minutes only</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       lastJDtail=0.0;</td><td> </td><td class="right">       lastJDtail=0.0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       orbitCached = 0;</td><td> </td><td class="right">       orbitCached = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       closeOrbit = acloseOrbit;</td><td> </td><td class="right">       closeOrbit = acloseOrbit;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       eclipticPos=Vec3d(0.,0.,0.);</td><td> </td><td class="right">       eclipticPos=Vec3d(0.,0.,0.);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rotLocalToParent = Mat4d::identity();</td><td> </td><td class="right">       rotLocalToParent = Mat4d::identity();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       texMap = StelApp::getInstance().getTextureManager().createTextureThr
ead(StelFileMgr::getInstallationDir()+"/textures/"+texMapName, StelTexture:
:StelTextureParams(true, GL_LINEAR, GL_REPEAT));</td><td> </td><td class="right">       texMap = StelApp::getInstance().getTextureManager().createTextureThr
ead(StelFileMgr::getInstallationDir()+"/textures/"+texMapName, StelTexture:
:StelTextureParams(true, GL_LINEAR, GL_REPEAT));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       gastailVertexArr.clear();</td><td> </td><td class="right">       gastailVertexArr.clear();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       dusttailVertexArr.clear();</td><td> </td><td class="right">       dusttailVertexArr.clear();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       comaVertexArr.clear();</td><td> </td><td class="right">       comaVertexArr.clear();</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">gastailColorArr.clear();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       dusttailColorArr.clear();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //Comet specific members</td><td> </td><td class="right">       //Comet specific members</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       absoluteMagnitude = 0;</td><td> </td><td class="right">       absoluteMagnitude = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       slopeParameter = -1;//== uninitialized: used in getVMagnitude()</td><td> </td><td class="right">       slopeParameter = -1;//== uninitialized: used in getVMagnitude()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //TODO: Name processing?</td><td> </td><td class="right">       //TODO: Name processing?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       nameI18 = englishName;</td><td> </td><td class="right">       nameI18 = englishName;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       flagLabels = true;</td><td> </td><td class="right">       flagLabels = true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 127</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 132</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //TODO: More checks?</td><td> </td><td class="right">       //TODO: More checks?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //TODO: Make it set-once like the number?</td><td> </td><td class="right">       //TODO: Make it set-once like the number?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       absoluteMagnitude = magnitude;</td><td> </td><td class="right">       absoluteMagnitude = magnitude;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       slopeParameter = slope;</td><td> </td><td class="right">       slopeParameter = slope;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">void Comet::translateName(const StelTranslator &amp;translator)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">{</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       nameI18 = translator.qtranslate(englishName);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">QString Comet::getInfoString(const StelCore *core, const InfoStringGroup &amp;f
lags) const</td><td> </td><td class="right">QString Comet::getInfoString(const StelCore *core, const InfoStringGroup &amp;f
lags) const</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //Mostly copied from Planet::getInfoString():</td><td> </td><td class="right">       //Mostly copied from Planet::getInfoString():</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QString str;</td><td> </td><td class="right">       QString str;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QTextStream oss(&amp;str);</td><td> </td><td class="right">       QTextStream oss(&amp;str);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags&amp;Name)</td><td> </td><td class="right">       if (flags&amp;Name)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss &lt;&lt; "&lt;h2&gt;";</td><td> </td><td class="right">               oss &lt;&lt; "&lt;h2&gt;";</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               oss &lt;&lt; <span class="delete">q_(englishName);  // UI translation can differ from s
ky</span> translation</td><td> </td><td class="rblock">               oss &lt;&lt; <span class="insert">getNameI18n();  // UI translation can differ from sky
</span> translation</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss.setRealNumberNotation(QTextStream::FixedNotation);</td><td> </td><td class="right">               oss.setRealNumberNotation(QTextStream::FixedNotation);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss.setRealNumberPrecision(1);</td><td> </td><td class="right">               oss.setRealNumberPrecision(1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (sphereScale != 1.f)</td><td> </td><td class="right">               if (sphereScale != 1.f)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       oss &lt;&lt; QString::fromUtf8(" (\xC3\x97") &lt;&lt; sphereScal
e &lt;&lt; ")";</td><td> </td><td class="right">                       oss &lt;&lt; QString::fromUtf8(" (\xC3\x97") &lt;&lt; sphereScal
e &lt;&lt; ")";</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss &lt;&lt; "&lt;/h2&gt;";</td><td> </td><td class="right">               oss &lt;&lt; "&lt;/h2&gt;";</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (flags&amp;ObjectType)</td><td> </td><td class="rblock">       if (flags&amp;ObjectType<span class="insert"> &amp;&amp; getPlanetType()!=isUNDEFINED</span>)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss &lt;&lt; q_("Type: &lt;b&gt;%1&lt;/b&gt;").arg(q_(getPlanetTypeString())) 
&lt;&lt; "&lt;br /&gt;";</td><td> </td><td class="right">               oss &lt;&lt; q_("Type: &lt;b&gt;%1&lt;/b&gt;").arg(q_(getPlanetTypeString())) 
&lt;&lt; "&lt;br /&gt;";</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags&amp;Magnitude)</td><td> </td><td class="right">       if (flags&amp;Magnitude)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">           if (core-&gt;getSkyDrawer()-&gt;getFlagHasAtmosphere())</td><td> </td><td class="right">           if (core-&gt;getSkyDrawer()-&gt;getFlagHasAtmosphere())</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               oss &lt;&lt; q_("Magnitude: &lt;b&gt;%1&lt;/b&gt; (extincted to: &lt;b&gt;%2&lt;/b&gt;)").
arg(QString::number(getVMagnitude(core), 'f', 2),</td><td> </td><td class="right">               oss &lt;&lt; q_("Magnitude: &lt;b&gt;%1&lt;/b&gt; (extincted to: &lt;b&gt;%2&lt;/b&gt;)").
arg(QString::number(getVMagnitude(core), 'f', 2),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                                                           
QString::number(getVMagnitudeWithExtinction(core), 'f', 2)) &lt;&lt; "&lt;br&gt;";</td><td> </td><td class="right">                                                                           
QString::number(getVMagnitudeWithExtinction(core), 'f', 2)) &lt;&lt; "&lt;br&gt;";</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">           else</td><td> </td><td class="right">           else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 284</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 294</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //Sources: http://www.clearskyinstitute.com/xephem/help/xephem.html#
mozTocId564354</td><td> </td><td class="right">       //Sources: http://www.clearskyinstitute.com/xephem/help/xephem.html#
mozTocId564354</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //(XEphem manual, section 7.1.2.3 "Magnitude models"), also</td><td> </td><td class="right">       //(XEphem manual, section 7.1.2.3 "Magnitude models"), also</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //http://www.ayton.id.au/gary/Science/Astronomy/Ast_comets.htm#Comet
%20facts:</td><td> </td><td class="right">       //http://www.ayton.id.au/gary/Science/Astronomy/Ast_comets.htm#Comet
%20facts:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // GZ: Note that Meeus, Astr.Alg.1998 p.231, has m=absoluteMagnitude
+5log10(observerCometDistance) + kappa*log10(cometSunDistance)</td><td> </td><td class="right">       // GZ: Note that Meeus, Astr.Alg.1998 p.231, has m=absoluteMagnitude
+5log10(observerCometDistance) + kappa*log10(cometSunDistance)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // with kappa typically 5..15. MPC provides Slope parameter. So we s
hould expect to have slopeParameter (a word only used for minor planets!) f
or our comets 2..6</td><td> </td><td class="right">       // with kappa typically 5..15. MPC provides Slope parameter. So we s
hould expect to have slopeParameter (a word only used for minor planets!) f
or our comets 2..6</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       double apparentMagnitude = absoluteMagnitude + 5 * std::log10(observ
erCometDistance) + 2.5 * slopeParameter * std::log10(cometSunDistance);</td><td> </td><td class="right">       double apparentMagnitude = absoluteMagnitude + 5 * std::log10(observ
erCometDistance) + 2.5 * slopeParameter * std::log10(cometSunDistance);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return apparentMagnitude;</td><td> </td><td class="right">       return apparentMagnitude;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">// <span class="delete">Compute the position in the parent Planet coordinate system</span></td><td> </td><td class="rblock"><span class="insert">void Comet::update(int deltaTime)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">// Actually call the provided function</span> to <span class="delete">compute the ecliptical position, </span></td><td> </td><td class="rblock"><span class="insert">{</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">and buildup the tails!</span></td><td> </td><td class="rblock"><span class="insert">       Planet::update(deltaTime);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">void Comet::computePosition(const</span> double <span class="delete">date)</span></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">{</span></td><td> </td><td class="rblock">       // <span class="insert">The rest used</span> to <span class="insert">be in computePosition(), but is better in update</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       Planet::computePosition(date);</span></td><td> </td><td class="rblock"><span class="insert">(). Unfortunately we need date (JD).</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       //GZ: I think we can make <span class="delete">deltaJD</span> adaptive, depending on <span class="delete">distance</span> to</td><td> </td><td class="rblock"><span class="insert">       StelCore* core=StelApp::getInstance().getCore();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> sun! For some reason though, this leads to a crash!</td><td> </td><td class="rblock">       double <span class="insert">date=core-&gt;getJDay();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">//deltaJD=StelCore::JD_SECOND</span> * qMax(1.0, <span class="delete">qMin(eclipticPos.length(),</span></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> 20.0));</td><td> </td><td class="rblock"><span class="insert">       // The CometOrbit is in fact available in userDataPtr!</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       CometOrbit* orbit=(CometOrbit*)userDataPtr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       Q_ASSERT(orbit);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (!orbit-&gt;objectDateValid(core-&gt;getJDay())) return; // don't do an</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ything if out of useful date range. This allows having hundreds of comet el</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ements.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       //GZ: I think we can make <span class="insert">deltaJDtail</span> adaptive, depending on <span class="insert">distanc</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e</span> to sun! For some reason though, this leads to a crash!</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">//deltaJDtail=StelCore::JD_SECOND</span> * qMax(1.0, <span class="insert">qMin(eclipticPos.lengt</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">h(),</span> 20.0));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (fabs(lastJDtail-date)&gt;deltaJDtail)</td><td> </td><td class="right">       if (fabs(lastJDtail-date)&gt;deltaJDtail)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               lastJDtail=date;</td><td> </td><td class="right">               lastJDtail=date;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               // GZ: Moved from draw() :-)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               // The CometOrbit is in fact available in userDataPtr!</td><td> </td><td class="right">               // The CometOrbit is in fact available in userDataPtr!</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               CometOrbit* orbit=(CometOrbit*)userDataPtr;</td><td> </td><td class="right">               CometOrbit* orbit=(CometOrbit*)userDataPtr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               Q_ASSERT(orbit);</td><td> </td><td class="right">               Q_ASSERT(orbit);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (!orbit-&gt;objectDateValid(date)) return; // out of useful 
date range. This should allow having hundreds of comet elements.</td><td> </td><td class="right">               if (!orbit-&gt;objectDateValid(date)) return; // out of useful 
date range. This should allow having hundreds of comet elements.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (orbit-&gt;getUpdateTails()){</td><td> </td><td class="right">               if (orbit-&gt;getUpdateTails()){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       // Compute lengths and orientations from orbit objec
t, but only if required.</td><td> </td><td class="right">                       // Compute lengths and orientations from orbit objec
t, but only if required.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       // This part moved from draw() to keep draw() free f
rom too much computation.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       tailFactors=getComaDiameterAndTailLengthAU();</td><td> </td><td class="right">                       tailFactors=getComaDiameterAndTailLengthAU();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       // Note that we use a diameter larger than what the 
formula returns. A scale factor of 1.2 is ad-hoc/empirical (GZ), but may lo
ok better.</td><td> </td><td class="right">                       // Note that we use a diameter larger than what the 
formula returns. A scale factor of 1.2 is ad-hoc/empirical (GZ), but may lo
ok better.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       computeComa(1.0f*tailFactors[0]);</td><td> </td><td class="rblock">                       computeComa(1.0f*tailFactors[0]);<span class="insert"> // TBD: APPARENTLY
 NO SCALING? REMOVE 1.0 and note above.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       tailActive = (tailFactors[1] &gt; tailFactors[0]); // I
nhibit tails drawing if too short. Would be nice to include geometric proje
ction angle, but this is too costly.</td><td> </td><td class="right">                       tailActive = (tailFactors[1] &gt; tailFactors[0]); // I
nhibit tails drawing if too short. Would be nice to include geometric proje
ction angle, but this is too costly.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (tailActive)</td><td> </td><td class="right">                       if (tailActive)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       {</td><td> </td><td class="right">                       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               float gasTailEndRadius=qMax(tailFactors[0], 
0.025f*tailFactors[1]) ; // This avoids too slim gas tails for bright comet
s like Hale-Bopp.</td><td> </td><td class="right">                               float gasTailEndRadius=qMax(tailFactors[0], 
0.025f*tailFactors[1]) ; // This avoids too slim gas tails for bright comet
s like Hale-Bopp.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               float gasparameter=gasTailEndRadius*gasTailE
ndRadius/(2.0f*tailFactors[1]); // parabola formula: z=r²/2p, so p=r²/2z</td><td> </td><td class="right">                               float gasparameter=gasTailEndRadius*gasTailE
ndRadius/(2.0f*tailFactors[1]); // parabola formula: z=r²/2p, so p=r²/2z</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // The dust tail is thicker and usually shor
ter. The factors can be configured in the elements.</td><td> </td><td class="right">                               // The dust tail is thicker and usually shor
ter. The factors can be configured in the elements.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               float dustparameter=gasTailEndRadius*gasTail
EndRadius*dustTailWidthFactor*dustTailWidthFactor/(2.0f*dustTailLengthFacto
r*tailFactors[1]);</td><td> </td><td class="right">                               float dustparameter=gasTailEndRadius*gasTail
EndRadius*dustTailWidthFactor*dustTailWidthFactor/(2.0f*dustTailLengthFacto
r*tailFactors[1]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // Find valid parameters to create paraboloi
d vertex arrays: dustTail, gasTail.</td><td> </td><td class="right">                               // Find valid parameters to create paraboloi
d vertex arrays: dustTail, gasTail.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               computeParabola(gasparameter, gasTailEndRadi
us, -0.5f*gasparameter, gastailVertexArr,  tailTexCoordArr, tailIndices);</td><td> </td><td class="right">                               computeParabola(gasparameter, gasTailEndRadi
us, -0.5f*gasparameter, gastailVertexArr,  tailTexCoordArr, tailIndices);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               <span class="delete">// This was for a rotated straight parabola:</span></td><td> </td><td class="rblock">                               <span class="insert">//gastailColorArr.fill(Vec3f(0.3,0.3,0.3), g</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                               //computeParabola(dustparameter, 2.0f*tailFa</span></td><td> </td><td class="rblock"><span class="insert">astailVertexArr.length());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ctors[0], -0.5f*dustparameter, dusttailVertexArr, dusttailTexCoordArr, dust</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">tailIndices);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // Now we make a skewed parabola. Skew facto
r (xOffset, last arg) is rather ad-hoc/empirical. TBD later: Find physicall
y correct solution.</td><td> </td><td class="right">                               // Now we make a skewed parabola. Skew facto
r (xOffset, last arg) is rather ad-hoc/empirical. TBD later: Find physicall
y correct solution.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               computeParabola(dustparameter, dustTailWidth
Factor*gasTailEndRadius, -0.5f*dustparameter, dusttailVertexArr, tailTexCoo
rdArr, tailIndices, 25.0f*orbit-&gt;getVelocity().length());</td><td> </td><td class="right">                               computeParabola(dustparameter, dustTailWidth
Factor*gasTailEndRadius, -0.5f*dustparameter, dusttailVertexArr, tailTexCoo
rdArr, tailIndices, 25.0f*orbit-&gt;getVelocity().length());</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               //dusttailColorArr.fill(Vec3f(0.3,0.3,0.3), 
dusttailVertexArr.length());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // 2014-08 for 0.13.1 Moved from drawTail() 
to save lots of computation per frame (There *are* folks downloading all 73
0 MPC current comet elements...)</td><td> </td><td class="right">                               // 2014-08 for 0.13.1 Moved from drawTail() 
to save lots of computation per frame (There *are* folks downloading all 73
0 MPC current comet elements...)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // Find rotation matrix from 0/0/1 to eclipt
icPosition: crossproduct for axis (normal vector), dotproduct for angle.</td><td> </td><td class="right">                               // Find rotation matrix from 0/0/1 to eclipt
icPosition: crossproduct for axis (normal vector), dotproduct for angle.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               Vec3d eclposNrm=eclipticPos; eclposNrm.norma
lize();</td><td> </td><td class="right">                               Vec3d eclposNrm=eclipticPos; eclposNrm.norma
lize();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               gasTailRot=Mat4d::rotation(Vec3d(0.0, 0.0, 1
.0)^(eclposNrm), std::acos(Vec3d(0.0, 0.0, 1.0).dot(eclposNrm)) );</td><td> </td><td class="right">                               gasTailRot=Mat4d::rotation(Vec3d(0.0, 0.0, 1
.0)^(eclposNrm), std::acos(Vec3d(0.0, 0.0, 1.0).dot(eclposNrm)) );</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               Vec3d velocity=orbit-&gt;getVelocity(); // [AU/
d]</td><td> </td><td class="right">                               Vec3d velocity=orbit-&gt;getVelocity(); // [AU/
d]</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // This was a try to rotate a straight parab
ola somewhat away from the antisolar direction.</td><td> </td><td class="right">                               // This was a try to rotate a straight parab
ola somewhat away from the antisolar direction.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               //Mat4d dustTailRot=Mat4d::rotation(eclposNr
m^(-velocity), 0.15f*std::acos(eclposNrm.dot(-velocity))); // GZ: This scal
e factor of 0.15 is empirical from photos of Halley and Hale-Bopp.</td><td> </td><td class="right">                               //Mat4d dustTailRot=Mat4d::rotation(eclposNr
m^(-velocity), 0.15f*std::acos(eclposNrm.dot(-velocity))); // GZ: This scal
e factor of 0.15 is empirical from photos of Halley and Hale-Bopp.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // The curved tail is curved towards positiv
e X. We first rotate around the Z axis into a direction opposite of the mot
ion vector, then again the antisolar rotation applies.</td><td> </td><td class="right">                               // The curved tail is curved towards positiv
e X. We first rotate around the Z axis into a direction opposite of the mot
ion vector, then again the antisolar rotation applies.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               // In addition, we let the dust tail already
 start with a light tilt.</td><td> </td><td class="right">                               // In addition, we let the dust tail already
 start with a light tilt.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               dustTailRot=gasTailRot * Mat4d::zrotation(at
an2(velocity[1], velocity[0]) + M_PI) * Mat4d::yrotation(5.0f*velocity.leng
th());</td><td> </td><td class="right">                               dustTailRot=gasTailRot * Mat4d::zrotation(at
an2(velocity[1], velocity[0]) + M_PI) * Mat4d::yrotation(5.0f*velocity.leng
th());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               // <span class="delete">TODO: If we want to be even faster, rotat
e vertex arrays here and not in drawTail()!</span></td><td> </td><td class="rblock">                               // <span class="insert">Rotate vertex arrays:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               Vec3d* gasVertices=(Vec3d*) (gastailVertexAr
r.data());</td><td> </td><td class="right">                               Vec3d* gasVertices=(Vec3d*) (gastailVertexAr
r.data());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               Vec3d* dustVertices=(Vec3d*) (dusttailVertex
Arr.data());</td><td> </td><td class="right">                               Vec3d* dustVertices=(Vec3d*) (dusttailVertex
Arr.data());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               for (int i=0; i&lt;COMET_TAIL_SLICES*COMET_TAIL
_STACKS+1; ++i)</td><td> </td><td class="right">                               for (int i=0; i&lt;COMET_TAIL_SLICES*COMET_TAIL
_STACKS+1; ++i)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               {</td><td> </td><td class="right">                               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                       gasVertices[i].transfo4d(gasTailRot)
;</td><td> </td><td class="right">                                       gasVertices[i].transfo4d(gasTailRot)
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                       dustVertices[i].transfo4d(dustTailRo
t);</td><td> </td><td class="right">                                       dustVertices[i].transfo4d(dustTailRo
t);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               }</td><td> </td><td class="right">                               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                                           </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       orbit-&gt;setUpdateTails(false); // don't update until 
position has been recalculated elsewhere</td><td> </td><td class="right">                       orbit-&gt;setUpdateTails(false); // don't update until 
position has been recalculated elsewhere</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">// Note: we can make deltaJDtail adaptive, depending on dist</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ance to sun!</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               //deltaJDtail=5.0*StelCore::JD_MINUTE * qMax(0.01, qMin(ecli</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">pticPos.length(), 20.0));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">// And also update magnitude and tail brightness/extinction here.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       const bool withAtmosphere=(core-&gt;getSkyDrawer()-&gt;getFlagHasAtmospher</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       StelToneReproducer* eye = core-&gt;getToneReproducer();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       float lum = core-&gt;getSkyDrawer()-&gt;surfacebrightnessToLuminance(getVM</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">agnitude(core)+13.0f); // How to calibrate?</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Get the luminance scaled between 0 and 1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       float aLum =eye-&gt;adaptLuminanceScaled(lum);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // To make comet more apparent in overviews, take field of view into</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> account:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       const float fov=core-&gt;getProjection(core-&gt;getAltAzModelViewTransform</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">())-&gt;getFov();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (fov&gt;20)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               aLum*= (fov/20.0f);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Now inhibit tail drawing if still too dim.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (aLum&lt;0.002f)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // Far too dim: don't even show tail...</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               tailBright=false;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       } else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               tailBright=true;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // Separate factors, but avoid overly bright tails. I limit to about</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> 0.7 for overlapping both tails which should not exceed full-white.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       float gasMagFactor=qMin(0.9f*aLum, 0.7f);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       float dustMagFactor=qMin(dustTailBrightnessFactor*aLum, 0.7f);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       Vec3f gasColor(0.15f*gasMagFactor,0.35f*gasMagFactor,0.6f*gasMagFact</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">or); // Orig color 0.15/0.15/0.6</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       Vec3f dustColor(dustMagFactor, dustMagFactor,0.6f*dustMagFactor);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (withAtmosphere)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               Extinction extinction=core-&gt;getSkyDrawer()-&gt;getExtinction();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // Not only correct the color values for extinction, but for</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> twilight conditions, also make tail end less visible.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // I consider sky brightness over 1cd/m^2 as reason to short</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">en tail.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // Below this brightness, the tail brightness loss by this m</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ethod is insignificant:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               // Just counting through the vertices might make a spiral ap</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">perance. Maybe even better than stackwise? Let's see...</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               const float avgAtmLum=GETSTELMODULE(LandscapeMgr)-&gt;getAtmosp</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">hereAverageLuminance();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               const float brightnessDecreasePerVertexFromHead=1.0f/(COMET_</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">TAIL_SLICES*COMET_TAIL_STACKS)  * avgAtmLum;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               float brightnessPerVertexFromHead=1.0f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               gastailColorArr.clear();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               dusttailColorArr.clear();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               for (int i=0; i&lt;gastailVertexArr.size(); ++i)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       // Gastail extinction:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       Vec3d vertAltAz=core-&gt;j2000ToAltAz(gastailVertexArr.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">at(i), StelCore::RefractionOn);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       vertAltAz.normalize();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       Q_ASSERT(fabs(vertAltAz.lengthSquared()-1.0) &lt; 0.001</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       float oneMag=0.0f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       extinction.forward(vertAltAz, &amp;oneMag);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       float extinctionFactor=std::pow(0.4f, oneMag); // dr</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">op of one magnitude: factor 2.5 or 40%</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       gastailColorArr.append(gasColor*extinctionFactor* br</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ightnessPerVertexFromHead);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       // dusttail extinction:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       vertAltAz=core-&gt;j2000ToAltAz(dusttailVertexArr.at(i)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">, StelCore::RefractionOn);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       vertAltAz.normalize();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       Q_ASSERT(fabs(vertAltAz.lengthSquared()-1.0) &lt; 0.001</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       oneMag=0.0f;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       extinction.forward(vertAltAz, &amp;oneMag);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       extinctionFactor=std::pow(0.4f, oneMag); // drop of </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">one magnitude: factor 2.5 or 40%</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       dusttailColorArr.append(dustColor*extinctionFactor *</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> brightnessPerVertexFromHead);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       brightnessPerVertexFromHead-=brightnessDecreasePerVe</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">rtexFromHead;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       else // no atmosphere: set all vertices to same brightness.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               gastailColorArr.fill(gasColor,   gastailVertexArr.length());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               dusttailColorArr.fill(dustColor, dusttailVertexArr.length())</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       //qDebug() &lt;&lt; "Comet " &lt;&lt; getEnglishName() &lt;&lt;  "JD: " &lt;&lt; date &lt;&lt; "ga</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">sR" &lt;&lt; gasColor[0] &lt;&lt; " dustR" &lt;&lt; dustColor[0];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">// Draw the Comet and all the related infos<span class="delete"> : name, circle etc... GZ: Taken
 </span>from Planet.cpp 2013-11-05 and extended</td><td> </td><td class="rblock">// Draw the Comet and all the related infos<span class="insert">: name, circle etc... GZ: Taken 
</span>from Planet.cpp 2013-11-05 and extended</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void Comet::draw(StelCore* core, float maxMagLabels, const QFont&amp; planetNam
eFont)</td><td> </td><td class="right">void Comet::draw(StelCore* core, float maxMagLabels, const QFont&amp; planetNam
eFont)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (hidden)</td><td> </td><td class="right">       if (hidden)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                                                                           </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (getEnglishName() == core-&gt;getCurrentLocation().planetName)</td><td> </td><td class="right">       if (getEnglishName() == core-&gt;getCurrentLocation().planetName)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       { // <span class="delete">GZ: Maybe even don't do that? E.g., draw tail while riding the 
come</span>t? Decide later.</td><td> </td><td class="rblock">       { // <span class="insert">Maybe even don't do that? E.g., draw tail while riding the come
</span>t? Decide later.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       // <span class="delete">GZ:</span> If comet is too faint to be seen, don't bother rendering. <span class="delete">(oo</span></td><td> </td><td class="rblock">       // <span class="insert">This test seemed necessary for reasonable fps in case too many co</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ps, should</span> have <span class="delete">been here in 2014-01... ;-)</span></td><td> </td><td class="rblock"><span class="insert">met elements are loaded.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">((getVMagnitude(core)-2.0f)</span> &gt; core-&gt;getSkyDrawer()-&gt;getLimitMagni</td><td> </td><td class="rblock"><span class="insert">       // Problematic: Early-out here of course disables the wanted hint ci</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">tude())</td><td> </td><td class="rblock"><span class="insert">rcles for dim comets.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // The line makes hints for comets 5 magnitudes below sky limiting m</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">agnitude visible.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       //</span> If comet is too faint to be seen, don't bother rendering. <span class="insert">(Massiv</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e speedup if people</span> have <span class="insert">hundreds of comet elements!)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if <span class="insert">((getVMagnitude(core)-5.0f)</span> &gt; core-&gt;getSkyDrawer()-&gt;getLimitMagni</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">tude())</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // The CometOrbit is in fact available in userDataPtr!</td><td> </td><td class="right">       // The CometOrbit is in fact available in userDataPtr!</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       CometOrbit* orbit=(CometOrbit*)userDataPtr;</td><td> </td><td class="right">       CometOrbit* orbit=(CometOrbit*)userDataPtr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       Q_ASSERT(orbit);</td><td> </td><td class="right">       Q_ASSERT(orbit);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (!orbit-&gt;objectDateValid(core-&gt;getJDay())) return; // don't draw 
at all <span class="delete">out of useful date range. This allows having hundreds of comet eleme
</span>nts.</td><td> </td><td class="rblock">       if (!orbit-&gt;objectDateValid(core-&gt;getJDay())) return; // don't draw 
at all <span class="insert">if out of useful date range. This allows having hundreds of comet el
eme</span>nts.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       Mat4d mat = Mat4d::translation(eclipticPos) * rotLocalToParent;</td><td> </td><td class="right">       Mat4d mat = Mat4d::translation(eclipticPos) * rotLocalToParent;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // This removed totally the Planet shaking bug!!!</td><td> </td><td class="right">       // This removed totally the Planet shaking bug!!!</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       StelProjector::ModelViewTranformP transfo = core-&gt;getHeliocentricEcl
ipticModelViewTransform();</td><td> </td><td class="right">       StelProjector::ModelViewTranformP transfo = core-&gt;getHeliocentricEcl
ipticModelViewTransform();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       transfo-&gt;combine(mat);</td><td> </td><td class="right">       transfo-&gt;combine(mat);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // Compute the 2D position and check if in the screen</td><td> </td><td class="right">       // Compute the 2D position and check if in the screen</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       const StelProjectorP prj = core-&gt;getProjection(transfo);</td><td> </td><td class="right">       const StelProjectorP prj = core-&gt;getProjection(transfo);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float screenSz = getAngularSize(core)*M_PI/180.*prj-&gt;getPixelPerRadA
tCenter();</td><td> </td><td class="right">       float screenSz = getAngularSize(core)*M_PI/180.*prj-&gt;getPixelPerRadA
tCenter();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float viewport_left = prj-&gt;getViewportPosX();</td><td> </td><td class="right">       float viewport_left = prj-&gt;getViewportPosX();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 409</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 499</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       labelsFader=true;</td><td> </td><td class="right">                       labelsFader=true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               else</td><td> </td><td class="right">               else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               {</td><td> </td><td class="right">               {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       labelsFader=false;</td><td> </td><td class="right">                       labelsFader=false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               drawHints(core, planetNameFont);</td><td> </td><td class="right">               drawHints(core, planetNameFont);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               draw3dModel(core,transfo,screenSz);</td><td> </td><td class="right">               draw3dModel(core,transfo,screenSz);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       // tails should also be drawn if comet core is off-screen...</td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">(tailActive)</span></td><td> </td><td class="rblock">       // <span class="insert">If comet is too faint to be seen, don't bother rendering. (Massiv</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e speedup if people have hundreds of comets!)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // This test moved here so that hints are still drawn.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if ((getVMagnitude(core)-3.0f) &gt; core-&gt;getSkyDrawer()-&gt;getLimitMagni</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">tude())</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       // but</span> tails should also be drawn if comet core is off-screen...</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if <span class="insert">(tailActive &amp;&amp; tailBright)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               drawTail(core,transfo,true);  // gas tail</td><td> </td><td class="right">               drawTail(core,transfo,true);  // gas tail</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               drawTail(core,transfo,false); // dust tail</td><td> </td><td class="right">               drawTail(core,transfo,false); // dust tail</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       //Coma: this is just a fan disk tilted towards the observer;-)</td><td> </td><td class="right">       //Coma: this is just a fan disk tilted towards the observer;-)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       drawComa(core, transfo);</td><td> </td><td class="right">       drawComa(core, transfo);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return;</td><td> </td><td class="right">       return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void Comet::drawTail(StelCore* core, StelProjector::ModelViewTranformP tran
sfo, bool gas)</td><td> </td><td class="right">void Comet::drawTail(StelCore* core, StelProjector::ModelViewTranformP tran
sfo, bool gas)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       StelPainter* sPainter = new StelPainter(core-&gt;getProjection(transfo)
);</td><td> </td><td class="right">       StelPainter* sPainter = new StelPainter(core-&gt;getProjection(transfo)
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glEnable(GL_BLEND);</td><td> </td><td class="right">       glEnable(GL_BLEND);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glBlendFunc(GL_ONE, GL_ONE);</td><td> </td><td class="right">       glBlendFunc(GL_ONE, GL_ONE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glDisable(GL_CULL_FACE);</td><td> </td><td class="right">       glDisable(GL_CULL_FACE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">// GZ: If we use getVMagnitudeWithExtinction(), a head extincted in </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">the horizon mist can completely hide an otherwise frighteningly long tail.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // we must use unextincted mag, but mix/dim with atmosphere/sky brig</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">htness.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // In addition, light falloff is a bit reduced for better visibility</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">. Power basis should be 0.4, we use 0.6.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       float magFactor=std::pow(0.6f , getVMagnitude(core));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       if (core-&gt;getSkyDrawer()-&gt;getFlagHasAtmosphere())</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               // Mix with sky brightness and light pollution: This is very</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> ad-hoc, if someone finds a better solution, please go ahead!</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               // Light pollution:</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               float bortleIndexFactor=0.1f * (11 - core-&gt;getSkyDrawer()-&gt;g</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">etBortleScaleIndex());</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               magFactor*= bortleIndexFactor*bortleIndexFactor; // GZ-Guess</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">timate for light pollution influence</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               // sky brightness: This is about 10 for twilight where brigh</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">t comet tails should already be visible. Dark night is close to 0.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               float avgAtmLum=GETSTELMODULE(LandscapeMgr)-&gt;getAtmosphereAv</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">erageLuminance();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               float atmLumFactor=(15.0f-avgAtmLum)/15.0f;  if (atmLumFacto</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">r&lt;0.05f) atmLumFactor=0.05f;    //atmLumFactor=std::sqrt(atmLumFactor);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               magFactor*=atmLumFactor*atmLumFactor;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       magFactor*=(gas? 0.9 : dustTailBrightnessFactor); // TBD: empirical </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">adjustment for texture brightness.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       magFactor=qMin(magFactor, 1.05f); // Limit excessively bright displa</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">y.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       tailTexture-&gt;bind();</td><td> </td><td class="right">       tailTexture-&gt;bind();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (gas) {</td><td> </td><td class="right">       if (gas) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">sPainter-&gt;setColor(0.15f*magFactor,0.15f*magFactor,0.6f*magF</span></td><td> </td><td class="rblock">               sPainter-&gt;setArrays((Vec3d*)gastailVertexArr.constData(), (V</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">actor);</span></td><td> </td><td class="rblock"><span class="insert">ec2f*)tailTexCoordArr.constData(), (Vec3f*)gastailColorArr.constData());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               sPainter-&gt;setArrays((Vec3d*)gastailVertexArr.constData(), (V</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ec2f*)tailTexCoordArr.constData());</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               sPainter-&gt;drawFromArray(StelPainter::Triangles, tailIndices.
size(), 0, true, tailIndices.constData());</td><td> </td><td class="right">               sPainter-&gt;drawFromArray(StelPainter::Triangles, tailIndices.
size(), 0, true, tailIndices.constData());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">sPainter-&gt;setColor(magFactor, magFactor,0.6f*magFactor);</span></td><td> </td><td class="rblock">               sPainter-&gt;setArrays((Vec3d*)dusttailVertexArr.constData(), (</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               sPainter-&gt;setArrays((Vec3d*)dusttailVertexArr.constData(), (</td><td> </td><td class="rblock"><span class="insert">Vec2f*)tailTexCoordArr.constData(), (Vec3f*)dusttailColorArr.constData());</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">Vec2f*)tailTexCoordArr.constData());</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               sPainter-&gt;drawFromArray(StelPainter::Triangles, tailIndices.
size(), 0, true, tailIndices.constData());</td><td> </td><td class="right">               sPainter-&gt;drawFromArray(StelPainter::Triangles, tailIndices.
size(), 0, true, tailIndices.constData());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glDisable(GL_BLEND);</td><td> </td><td class="right">       glDisable(GL_BLEND);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (sPainter)</td><td> </td><td class="right">       if (sPainter)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               delete sPainter;</td><td> </td><td class="right">               delete sPainter;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sPainter=NULL;</td><td> </td><td class="right">       sPainter=NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void Comet::drawComa(StelCore* core, StelProjector::ModelViewTranformP tran
sfo)</td><td> </td><td class="right">void Comet::drawComa(StelCore* core, StelProjector::ModelViewTranformP tran
sfo)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 477</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 555</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       Vec3d eclposNrm=eclipticPos - core-&gt;getObserverHeliocentricEclipticP
os()  ; eclposNrm.normalize();</td><td> </td><td class="right">       Vec3d eclposNrm=eclipticPos - core-&gt;getObserverHeliocentricEclipticP
os()  ; eclposNrm.normalize();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       Mat4d comarot=Mat4d::rotation(Vec3d(0.0, 0.0, 1.0)^(eclposNrm), std:
:acos(Vec3d(0.0, 0.0, 1.0).dot(eclposNrm)) );</td><td> </td><td class="right">       Mat4d comarot=Mat4d::rotation(Vec3d(0.0, 0.0, 1.0)^(eclposNrm), std:
:acos(Vec3d(0.0, 0.0, 1.0).dot(eclposNrm)) );</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       StelProjector::ModelViewTranformP transfo2 = transfo-&gt;clone();</td><td> </td><td class="right">       StelProjector::ModelViewTranformP transfo2 = transfo-&gt;clone();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       transfo2-&gt;combine(comarot);</td><td> </td><td class="right">       transfo2-&gt;combine(comarot);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       StelPainter* sPainter = new StelPainter(core-&gt;getProjection(transfo2
));</td><td> </td><td class="right">       StelPainter* sPainter = new StelPainter(core-&gt;getProjection(transfo2
));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glEnable(GL_BLEND);</td><td> </td><td class="right">       glEnable(GL_BLEND);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glBlendFunc(GL_ONE, GL_ONE);</td><td> </td><td class="right">       glBlendFunc(GL_ONE, GL_ONE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glDisable(GL_CULL_FACE);</td><td> </td><td class="right">       glDisable(GL_CULL_FACE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">// GZ: For the coma, we can use extinction via atmosphere.</span></td><td> </td><td class="rblock">       <span class="insert">StelToneReproducer* eye = core-&gt;getToneReproducer();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       // In addition, light falloff is a bit reduced for better visibility</span></td><td> </td><td class="rblock">       float <span class="insert">lum = core-&gt;getSkyDrawer()-&gt;surfacebrightnessToLuminance(getVM</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">. Power basis should be 0.4, we use 0.6.</span></td><td> </td><td class="rblock"><span class="insert">agnitudeWithExtinction(core)+11.0f);</span> // <span class="insert">How to calibrate?</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       float minSkyMag=core-&gt;getSkyDrawer()-&gt;getLimitMagnitude();</span></td><td> </td><td class="rblock"><span class="insert">       // Get the luminance scaled between 0 and 1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       float <span class="delete">mag100pct=minSkyMag-6.0f;</span> // <span class="delete">should be 5, but let us draw it a</span></td><td> </td><td class="rblock">       float <span class="insert">aLum =eye-&gt;adaptLuminanceScaled(lum);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> bit brighter.</span></td><td> </td><td class="rblock">       float <span class="insert">magFactor=qMin(qMax(aLum, 0.25f),</span> 2.0f);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       float <span class="delete">magDrop=getVMagnitudeWithExtinction(core)-mag100pct;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       float <span class="delete">magFactor=std::pow(0.6f , magDrop);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       magFactor=qMin(magFactor,</span> 2.0f); <span class="delete">// Limit excessively bright display</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">.</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       comaTexture-&gt;bind();</td><td> </td><td class="right">       comaTexture-&gt;bind();</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       sPainter-&gt;setColor(<span class="delete">magFactor,magFactor,0.6f*</span>magFactor);</td><td> </td><td class="rblock">       sPainter-&gt;setColor(<span class="insert">0.3f*magFactor,0.7*magFactor,</span>magFactor);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sPainter-&gt;setArrays((Vec3d*)comaVertexArr.constData(), (Vec2f*)comaT
exCoordArr.constData());</td><td> </td><td class="right">       sPainter-&gt;setArrays((Vec3d*)comaVertexArr.constData(), (Vec2f*)comaT
exCoordArr.constData());</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sPainter-&gt;drawFromArray(StelPainter::Triangles, comaVertexArr.size()
/3);</td><td> </td><td class="right">       sPainter-&gt;drawFromArray(StelPainter::Triangles, comaVertexArr.size()
/3);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       glDisable(GL_BLEND);</td><td> </td><td class="right">       glDisable(GL_BLEND);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (sPainter)</td><td> </td><td class="right">       if (sPainter)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               delete sPainter;</td><td> </td><td class="right">               delete sPainter;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sPainter=NULL;</td><td> </td><td class="right">       sPainter=NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 520</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 595</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void Comet::computeComa(const float diameter)</td><td> </td><td class="right">void Comet::computeComa(const float diameter)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       StelPainter::computeFanDisk(0.5f*diameter, 3, 3, comaVertexArr, coma
TexCoordArr);</td><td> </td><td class="right">       StelPainter::computeFanDisk(0.5f*diameter, 3, 3, comaVertexArr, coma
TexCoordArr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">//! create parabola shell to represent a tail. Designed for slices=16, stac
ks=16, but should work with other sizes as well.</td><td> </td><td class="right">//! create parabola shell to represent a tail. Designed for slices=16, stac
ks=16, but should work with other sizes as well.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">//! (Maybe slices must be an even number.)</td><td> </td><td class="right">//! (Maybe slices must be an even number.)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// Parabola equation: z=x²/2p.</td><td> </td><td class="right">// Parabola equation: z=x²/2p.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// xOffset for the dust tail, this may introduce a bend. Units are x per sq
rt(z).</td><td> </td><td class="right">// xOffset for the dust tail, this may introduce a bend. Units are x per sq
rt(z).</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void Comet::computeParabola(const float parameter, const float radius, cons
t float zshift,</td><td> </td><td class="right">void Comet::computeParabola(const float parameter, const float radius, cons
t float zshift,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           QVector&lt;<span class="delete">double&gt;&amp; vertexArr, QVector&lt;float&gt;&amp; texC
o</span>ordArr, QVector&lt;unsigned short&gt; &amp;indices, const float xOffset) {</td><td> </td><td class="rblock">                           QVector&lt;<span class="insert">Vec3d&gt;&amp; vertexArr, QVector&lt;float&gt;&amp; texCo
</span>ordArr, QVector&lt;unsigned short&gt; &amp;indices, const float xOffset) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       // <span class="delete">GZ:</span> keep the array and replace contents. However, using replace()</td><td> </td><td class="rblock">       // keep the array and replace contents. However, using replace() is </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> is only slightly faster.</td><td> </td><td class="rblock">only slightly faster.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (vertexArr.length() &lt; <span class="delete">(3*(COMET_TAIL_SLICES*COMET_TAIL_STACKS+1))</span></td><td> </td><td class="rblock">       if (vertexArr.length() &lt; <span class="insert">((COMET_TAIL_SLICES*COMET_TAIL_STACKS+1)))</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">)</span></td><td> </td><td class="rblock"><span class="insert">               vertexArr.resize((COMET_TAIL_SLICES*COMET_TAIL_STACKS+1));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               vertexArr.resize(3*(COMET_TAIL_SLICES*COMET_TAIL_STACKS+1));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (createTailIndices) indices.clear();</td><td> </td><td class="right">       if (createTailIndices) indices.clear();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (createTailTextureCoords) texCoordArr.clear();</td><td> </td><td class="right">       if (createTailTextureCoords) texCoordArr.clear();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int i;</td><td> </td><td class="right">       int i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // The parabola has triangular faces with vertices on two circles th
at are rotated against each other.</td><td> </td><td class="right">       // The parabola has triangular faces with vertices on two circles th
at are rotated against each other.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float xa[2*COMET_TAIL_SLICES];</td><td> </td><td class="right">       float xa[2*COMET_TAIL_SLICES];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float ya[2*COMET_TAIL_SLICES];</td><td> </td><td class="right">       float ya[2*COMET_TAIL_SLICES];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float x, y, z;</td><td> </td><td class="right">       float x, y, z;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // fill xa, ya with sin/cosines. TBD: make more efficient with index
 mirroring etc.</td><td> </td><td class="right">       // fill xa, ya with sin/cosines. TBD: make more efficient with index
 mirroring etc.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       float da=M_PI/COMET_TAIL_SLICES; // full circle/2slices</td><td> </td><td class="right">       float da=M_PI/COMET_TAIL_SLICES; // full circle/2slices</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i=0; i&lt;2*COMET_TAIL_SLICES; ++i){</td><td> </td><td class="right">       for (i=0; i&lt;2*COMET_TAIL_SLICES; ++i){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               xa[i]=-sin(i*da);</td><td> </td><td class="right">               xa[i]=-sin(i*da);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               ya[i]=cos(i*da);</td><td> </td><td class="right">               ya[i]=cos(i*da);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       vertexArr.replace(0, <span class="delete">0.0); vertexArr.replace(1, 0.0); vertexArr.repl</span></td><td> </td><td class="rblock">       vertexArr.replace(0, <span class="insert">Vec3d(0.0, 0.0, zshift));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ace(2, zshift);</span></td><td> </td><td class="rblock">       int <span class="insert">vertexArrIndex=1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       int <span class="delete">vertexArrIndex=3;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (createTailTextureCoords) texCoordArr &lt;&lt; 0.5f &lt;&lt; 0.5f;</td><td> </td><td class="right">       if (createTailTextureCoords) texCoordArr &lt;&lt; 0.5f &lt;&lt; 0.5f;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // define the indices lying on circles, starting at 1: odd rings hav
e 1/slices+1/2slices, even-numbered rings straight 1/slices</td><td> </td><td class="right">       // define the indices lying on circles, starting at 1: odd rings hav
e 1/slices+1/2slices, even-numbered rings straight 1/slices</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // inner ring#1</td><td> </td><td class="right">       // inner ring#1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int ring;</td><td> </td><td class="right">       int ring;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (ring=1; ring&lt;=COMET_TAIL_STACKS; ++ring){</td><td> </td><td class="right">       for (ring=1; ring&lt;=COMET_TAIL_STACKS; ++ring){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               z=ring*radius/COMET_TAIL_STACKS; z=z*z/(2*parameter) + zshif
t;</td><td> </td><td class="right">               z=ring*radius/COMET_TAIL_STACKS; z=z*z/(2*parameter) + zshif
t;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               float xShift= xOffset*z*z;</td><td> </td><td class="right">               float xShift= xOffset*z*z;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               for (i=ring &amp; 1; i&lt;2*COMET_TAIL_SLICES; i+=2) { // i.e., rin
g1 has shifted vertices, ring2 has even ones.</td><td> </td><td class="right">               for (i=ring &amp; 1; i&lt;2*COMET_TAIL_SLICES; i+=2) { // i.e., rin
g1 has shifted vertices, ring2 has even ones.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       x=xa[i]*radius*ring/COMET_TAIL_STACKS;</td><td> </td><td class="right">                       x=xa[i]*radius*ring/COMET_TAIL_STACKS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       y=ya[i]*radius*ring/COMET_TAIL_STACKS;</td><td> </td><td class="right">                       y=ya[i]*radius*ring/COMET_TAIL_STACKS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       vertexArr.replace(vertexArrIndex++, <span class="delete">x+xShift);</span></td><td> </td><td class="rblock">                       vertexArr.replace(vertexArrIndex++, <span class="insert">Vec3d(x+xShift, </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       vertexArr.replace(vertexArrIndex++, y);</span></td><td> </td><td class="rblock"><span class="insert">y, z));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       vertexArr.replace(vertexArrIndex++, z);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (createTailTextureCoords) texCoordArr &lt;&lt; 0.5+ 0.5
*x/radius &lt;&lt; 0.5+0.5*y/radius;</td><td> </td><td class="right">                       if (createTailTextureCoords) texCoordArr &lt;&lt; 0.5+ 0.5
*x/radius &lt;&lt; 0.5+0.5*y/radius;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       // now link the faces with indices.</td><td> </td><td class="right">       // now link the faces with indices.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (createTailIndices)</td><td> </td><td class="right">       if (createTailIndices)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       {</td><td> </td><td class="right">       {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               for (i=1; i&lt;COMET_TAIL_SLICES; ++i) indices &lt;&lt; 0 &lt;&lt; i &lt;&lt; i+1
;</td><td> </td><td class="right">               for (i=1; i&lt;COMET_TAIL_SLICES; ++i) indices &lt;&lt; 0 &lt;&lt; i &lt;&lt; i+1
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               indices &lt;&lt; 0 &lt;&lt; COMET_TAIL_SLICES &lt;&lt; 1; // close inner fan.</td><td> </td><td class="right">               indices &lt;&lt; 0 &lt;&lt; COMET_TAIL_SLICES &lt;&lt; 1; // close inner fan.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               // The other slices are a repeating pattern of 2 possibiliti
es. Index @ring always is on the inner ring (slices-agon)</td><td> </td><td class="right">               // The other slices are a repeating pattern of 2 possibiliti
es. Index @ring always is on the inner ring (slices-agon)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               for (ring=1; ring&lt;COMET_TAIL_STACKS; ring+=2) { // odd rings</td><td> </td><td class="right">               for (ring=1; ring&lt;COMET_TAIL_STACKS; ring+=2) { // odd rings</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 595</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 668</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       createTailIndices=false;</td><td> </td><td class="right">       createTailIndices=false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       createTailTextureCoords=false;</td><td> </td><td class="right">       createTailTextureCoords=false;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">// These are to avoid having index arrays for each comet when all are equal
.</td><td> </td><td class="right">// These are to avoid having index arrays for each comet when all are equal
.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">bool Comet::createTailIndices=true;</td><td> </td><td class="right">bool Comet::createTailIndices=true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">bool Comet::createTailTextureCoords=true;</td><td> </td><td class="right">bool Comet::createTailTextureCoords=true;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">StelTextureSP Comet::comaTexture;</td><td> </td><td class="right">StelTextureSP Comet::comaTexture;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">StelTextureSP Comet::tailTexture;</td><td> </td><td class="right">StelTextureSP Comet::tailTexture;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">QVector&lt;float&gt; Comet::tailTexCoordArr; // computed only once <span class="delete">FOR ALL COMETS</span></td><td> </td><td class="rblock">QVector&lt;float&gt; Comet::tailTexCoordArr; // computed only once <span class="insert">for all Comets</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">!</span></td><td> </td><td class="rblock"><span class="insert">.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">QVector&lt;unsigned short&gt; Comet::tailIndices; // computed only once <span class="delete">FOR ALL</span> C</td><td> </td><td class="rblock">QVector&lt;unsigned short&gt; Comet::tailIndices; // computed only once <span class="insert">for all</span> C</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">OMETS!</span></td><td> </td><td class="rblock"><span class="insert">omets.</span></td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 33 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>94 lines changed or deleted</i></th><th><i> </i></th><th><i>179 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
