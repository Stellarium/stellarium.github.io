<?xml version="1.0" encoding="utf-8"?>
<html>
    <head>
      <title>Stellarium: core/renderer/StelCircleArcRenderer.hpp Source File</title>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32" rowspan="2"><a href="http://www.stellarium.org"><img src="stellarium-logo.png" align="left" border="0" /></a></td>
<td width="1" rowspan="2">&nbsp;&nbsp;</td>
<td style="font-size:120%;font-weight:bolder;">Stellarium 0.12.1</td>
<td align="right" valign="top" width="230" rowspan="2"></td></tr><tr>
<td class="postheader" valign="center">
 <a href="index.html">Home</a>&nbsp;&middot;
 <a href="namespaces.html">All&nbsp;Namespaces</a>&nbsp;&middot;
 <a href="classes.html">All&nbsp;Classes</a>&nbsp;&middot;
 <a href="functions.html">Functions</a>&nbsp;&middot;
 <a href="codingStyle.html">Coding Style</a>&nbsp;&middot;
 <a href="scripting.html">Scripting</a>&nbsp;&middot;
 <a href="plugins.html">Plugins</a>&nbsp;&middot;
 <a href="renderer.html">Renderer</a>&nbsp;&middot;
 <a href="fileStructure.html">File Structure</a>
</td>
</tr>
</table>
<!-- Generated by Doxygen 1.7.4 -->
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_5a58d40a861609d2ce17e428756ab7dd.html">core</a>      </li>
      <li class="navelem"><a class="el" href="dir_ff9b235ca7044145e202b9972934b704.html">renderer</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">StelCircleArcRenderer.hpp</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Stellarium</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 2012 Ferdinand Majerech</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00006"></a>00006 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00007"></a>00007 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00008"></a>00008 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00016"></a>00016 <span class="comment"> * along with this program; if not, write to the Free Software</span>
<a name="l00017"></a>00017 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Suite 500, Boston, MA  02110-1335, USA.</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#ifndef _STELCIRCLEARCRENDERER_HPP_</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#define _STELCIRCLEARCRENDERER_HPP_</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;QLinkedList&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;GenericVertexTypes.hpp&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;StelProjector.hpp&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="StelSphereGeometry_8hpp.html" title="Define all SphericalGeometry primitives as well as the SphericalRegionP type.">StelSphereGeometry.hpp</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;StelRenderer.hpp&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00051"></a><a class="code" href="classStelCircleArcRenderer.html">00051</a> <span class="keyword">class </span><a class="code" href="classStelCircleArcRenderer.html" title="Provides functions to draw circle arcs using StelRenderer.">StelCircleArcRenderer</a>
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053 <span class="keyword">public</span>:
<a name="l00058"></a><a class="code" href="classStelCircleArcRenderer.html#afe0da4725d296de71d5078a8ea660327">00058</a>     <a class="code" href="classStelCircleArcRenderer.html#afe0da4725d296de71d5078a8ea660327" title="Construct a StelCircleArcRenderer using specified renderer.">StelCircleArcRenderer</a>(<a class="code" href="classStelRenderer.html" title="Main class of the Renderer subsystem.">StelRenderer</a>* renderer, <a class="code" href="classQSharedPointer.html">StelProjectorP</a> projector)
<a name="l00059"></a>00059         : renderer(renderer)
<a name="l00060"></a>00060         , projector(&amp;(*projector))
<a name="l00061"></a>00061     {
<a name="l00062"></a>00062         smallCircleVertexBuffer = renderer-&gt;<a class="code" href="classStelRenderer.html#ab20687284a2419e5db806e74dfe91b5b" title="Create an empty vertex buffer and return a pointer to it.">createVertexBuffer</a>&lt;<a class="code" href="structVertexP2.html" title="Vertex with only a 2D position.">VertexP2</a>&gt;(PrimitiveType_LineStrip);
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064 
<a name="l00069"></a><a class="code" href="classStelCircleArcRenderer.html#a7669aa6392588d0646a39d1811420cf6">00069</a>     <a class="code" href="classStelCircleArcRenderer.html#afe0da4725d296de71d5078a8ea660327" title="Construct a StelCircleArcRenderer using specified renderer.">StelCircleArcRenderer</a>(<a class="code" href="classStelRenderer.html" title="Main class of the Renderer subsystem.">StelRenderer</a>* renderer, <a class="code" href="classStelProjector.html" title="Provide the main interface to all operations of projecting coordinates from sky to screen...">StelProjector</a>* projector)
<a name="l00070"></a>00070         : renderer(renderer)
<a name="l00071"></a>00071         , projector(projector)
<a name="l00072"></a>00072     {
<a name="l00073"></a>00073         smallCircleVertexBuffer = renderer-&gt;<a class="code" href="classStelRenderer.html#ab20687284a2419e5db806e74dfe91b5b" title="Create an empty vertex buffer and return a pointer to it.">createVertexBuffer</a>&lt;<a class="code" href="structVertexP2.html" title="Vertex with only a 2D position.">VertexP2</a>&gt;(PrimitiveType_LineStrip);
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075 
<a name="l00077"></a><a class="code" href="classStelCircleArcRenderer.html#a6c56b8e546d2646577d2c8fa3b77bc22">00077</a>     <a class="code" href="classStelCircleArcRenderer.html#a6c56b8e546d2646577d2c8fa3b77bc22" title="Destroy the StelCircleArcRenderer, freeing any vertex buffers.">~StelCircleArcRenderer</a>()
<a name="l00078"></a>00078     {
<a name="l00079"></a>00079         <span class="keyword">delete</span> smallCircleVertexBuffer;
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 
<a name="l00099"></a>00099     <span class="keywordtype">void</span> <a class="code" href="classStelCircleArcRenderer.html#a8f64a1916df678ff4248a9c7a0116d45" title="Draw a great circle arc between points start and stop.">drawGreatCircleArc</a>
<a name="l00100"></a><a class="code" href="classStelCircleArcRenderer.html#a8f64a1916df678ff4248a9c7a0116d45">00100</a>         (<span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; start, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; stop, <span class="keyword">const</span> <a class="code" href="classSphericalCap.html" title="A SphericalCap is defined by a direction and an aperture.">SphericalCap</a>* clippingCap = NULL,
<a name="l00101"></a>00101          <span class="keywordtype">void</span> (*viewportEdgeIntersectCallback)
<a name="l00102"></a>00102               (<span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; screenPos, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; direction, <span class="keywordtype">void</span>* userData) = NULL, 
<a name="l00103"></a>00103          <span class="keywordtype">void</span>* userData = NULL)
<a name="l00104"></a>00104     {
<a name="l00105"></a>00105         <a class="code" href="classVector3.html">Vec3d</a> pt1, pt2;
<a name="l00106"></a>00106         rotCenter = <a class="code" href="classVector3.html">Vec3d</a>(0);
<a name="l00107"></a>00107         <span class="keywordflow">if</span> (NULL != clippingCap)
<a name="l00108"></a>00108         {
<a name="l00109"></a>00109             pt1 = start;
<a name="l00110"></a>00110             pt2 = stop;
<a name="l00111"></a>00111             <span class="keywordflow">if</span> (clippingCap-&gt;clipGreatCircle(pt1, pt2))
<a name="l00112"></a>00112             {
<a name="l00113"></a>00113               <a class="code" href="classStelCircleArcRenderer.html#a4ee0f5b5de1371052d90a761cb646c84" title="Draw a small circle arc between points start and stop.">drawSmallCircleArc</a>(pt1, pt2, viewportEdgeIntersectCallback, userData);
<a name="l00114"></a>00114             }
<a name="l00115"></a>00115             <span class="keywordflow">return</span>;
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117         <a class="code" href="classStelCircleArcRenderer.html#a4ee0f5b5de1371052d90a761cb646c84" title="Draw a small circle arc between points start and stop.">drawSmallCircleArc</a>(start, stop, viewportEdgeIntersectCallback, userData);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 
<a name="l00141"></a><a class="code" href="classStelCircleArcRenderer.html#a5d1c776d95e585c4fa5803635c863582">00141</a>     <span class="keywordtype">void</span> <a class="code" href="classStelCircleArcRenderer.html#a5d1c776d95e585c4fa5803635c863582" title="Draw a series of great circle arcs between specified points.">drawGreatCircleArcs</a>(<span class="keyword">const</span> QVector&lt;Vec3d&gt;&amp; points, <span class="keyword">const</span> PrimitiveType primitiveType,
<a name="l00142"></a>00142                              <span class="keyword">const</span> <a class="code" href="classSphericalCap.html" title="A SphericalCap is defined by a direction and an aperture.">SphericalCap</a>* clippingCap)
<a name="l00143"></a>00143     {
<a name="l00144"></a>00144         Q_ASSERT_X(points.size() != 1, Q_FUNC_INFO, 
<a name="l00145"></a>00145                    <span class="stringliteral">&quot;Need zero or at least 2 points to draw circle arcs&quot;</span>);
<a name="l00146"></a>00146         <span class="keywordflow">switch</span>(primitiveType)
<a name="l00147"></a>00147         {
<a name="l00148"></a>00148             <span class="keywordflow">case</span> PrimitiveType_Lines:
<a name="l00149"></a>00149                 Q_ASSERT_X(points.size() % 2 == 0, Q_FUNC_INFO, 
<a name="l00150"></a>00150                            <span class="stringliteral">&quot;Need an even number of points to draw great circle arcs from a &quot;</span>
<a name="l00151"></a>00151                            <span class="stringliteral">&quot;lines primitive type.&quot;</span>);
<a name="l00152"></a>00152                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = 0; p &lt; points.size(); p += 2 ) 
<a name="l00153"></a>00153                 {
<a name="l00154"></a>00154                     <a class="code" href="classStelCircleArcRenderer.html#a8f64a1916df678ff4248a9c7a0116d45" title="Draw a great circle arc between points start and stop.">drawGreatCircleArc</a>(points.at(p), points.at(p+1), clippingCap);
<a name="l00155"></a>00155                 }
<a name="l00156"></a>00156                 <span class="keywordflow">break</span>;
<a name="l00157"></a>00157             <span class="keywordflow">case</span> PrimitiveType_LineLoop:
<a name="l00158"></a>00158                 <span class="keywordflow">if</span>(points.size() &gt; 0)
<a name="l00159"></a>00159                 {
<a name="l00160"></a>00160                     <a class="code" href="classStelCircleArcRenderer.html#a8f64a1916df678ff4248a9c7a0116d45" title="Draw a great circle arc between points start and stop.">drawGreatCircleArc</a>(points.at(points.size() - 1), points.at(0));
<a name="l00161"></a>00161                 }
<a name="l00162"></a>00162             <span class="keywordflow">case</span> PrimitiveType_LineStrip:
<a name="l00163"></a>00163                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = 1; p &lt; points.size(); p++) 
<a name="l00164"></a>00164                 {
<a name="l00165"></a>00165                     <a class="code" href="classStelCircleArcRenderer.html#a8f64a1916df678ff4248a9c7a0116d45" title="Draw a great circle arc between points start and stop.">drawGreatCircleArc</a>(points.at(p - 1), points.at(p));
<a name="l00166"></a>00166                 }
<a name="l00167"></a>00167                 <span class="keywordflow">break</span>;
<a name="l00168"></a>00168             <span class="keywordflow">default</span>:
<a name="l00169"></a>00169                 Q_ASSERT_X(<span class="keyword">false</span>, Q_FUNC_INFO, <span class="stringliteral">&quot;Unsupported primitive type to draw circle arcs from&quot;</span>);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 
<a name="l00174"></a><a class="code" href="classStelCircleArcRenderer.html#a2e450fb3a582b731c942a156727bbcbd">00174</a>     <span class="keywordtype">void</span> <a class="code" href="classStelCircleArcRenderer.html#a2e450fb3a582b731c942a156727bbcbd" title="Set rotation point to draw a small circle around.">setRotCenter</a>(<span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a> center)
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176         rotCenter = center;
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178 
<a name="l00198"></a>00198     <span class="keywordtype">void</span> <a class="code" href="classStelCircleArcRenderer.html#a4ee0f5b5de1371052d90a761cb646c84" title="Draw a small circle arc between points start and stop.">drawSmallCircleArc</a>
<a name="l00199"></a><a class="code" href="classStelCircleArcRenderer.html#a4ee0f5b5de1371052d90a761cb646c84">00199</a>         (<span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; start, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; stop,
<a name="l00200"></a>00200          <span class="keywordtype">void</span> (*viewportEdgeIntersectCallback)
<a name="l00201"></a>00201               (<span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; screenPos, <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; direction, <span class="keywordtype">void</span>* userData), 
<a name="l00202"></a>00202          <span class="keywordtype">void</span>* userData)
<a name="l00203"></a>00203     {
<a name="l00204"></a>00204         Q_ASSERT_X(smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a099305f64ca1066494e6bce062ba9253" title="Returns the number of vertices in the buffer.">length</a>() == 0, Q_FUNC_INFO,
<a name="l00205"></a>00205                    <span class="stringliteral">&quot;Small circle buffer must be empty before drawing&quot;</span>);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#abd0e9d5b7e8f83e3309c5810a024958b" title="Unlock the buffer. This is needed to modify the buffer after drawing.">unlock</a>();
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         vertexList.clear(); 
<a name="l00210"></a>00210         <a class="code" href="classVector3.html">Vec3d</a> win1, win2;
<a name="l00211"></a>00211         win1[2] = projector-&gt;<a class="code" href="classStelProjector.html#af7cbcb16087629ef2875a98ec6e24fa5" title="Project the vector v from the current frame into the viewport.">project</a>(start, win1) ? 1.0 : -1.1;
<a name="l00212"></a>00212         win2[2] = projector-&gt;<a class="code" href="classStelProjector.html#af7cbcb16087629ef2875a98ec6e24fa5" title="Project the vector v from the current frame into the viewport.">project</a>(stop, win2)  ? 1.0 : -1.0;
<a name="l00213"></a>00213         vertexList.append(win1);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (rotCenter.lengthSquared() &lt; 0.00000001)
<a name="l00216"></a>00216         {
<a name="l00217"></a>00217             <span class="comment">// Great circle</span>
<a name="l00218"></a>00218             <span class="comment">// Tesselate the arc in small segments in a way so that the lines look smooth</span>
<a name="l00219"></a>00219             fIter(start, stop, win1, win2, 
<a name="l00220"></a>00220                   vertexList.insert(vertexList.end(), win2), 1.0);
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222         <span class="keywordflow">else</span>
<a name="l00223"></a>00223         {
<a name="l00224"></a>00224             <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a> tmp = (rotCenter ^ start) / rotCenter.length();
<a name="l00225"></a>00225             <span class="keyword">const</span> <span class="keywordtype">double</span> radius = fabs(tmp.length());
<a name="l00226"></a>00226             <span class="comment">// Tesselate the arc in small segments in a way so that the lines look smooth</span>
<a name="l00227"></a>00227             fIter(start - rotCenter, stop - rotCenter, win1, win2, 
<a name="l00228"></a>00228                   vertexList.insert(vertexList.end(), win2), radius);
<a name="l00229"></a>00229         }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">// And draw.</span>
<a name="l00232"></a>00232         QLinkedList&lt;Vec3d&gt;::ConstIterator i = vertexList.constBegin();
<a name="l00233"></a>00233         <span class="keywordflow">while</span> (i + 1 != vertexList.constEnd())
<a name="l00234"></a>00234         {
<a name="l00235"></a>00235             <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; p1 = *i;
<a name="l00236"></a>00236             <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; p2 = *(++i);
<a name="l00237"></a>00237             <span class="keyword">const</span> <span class="keywordtype">bool</span> p1InViewport = projector-&gt;<a class="code" href="classStelProjector.html#aa2b615c1df69f1774a3a4f8a26bffa6e" title="Check to see if a 2d position is inside the viewport.">checkInViewport</a>(p1);
<a name="l00238"></a>00238             <span class="keyword">const</span> <span class="keywordtype">bool</span> p2InViewport = projector-&gt;<a class="code" href="classStelProjector.html#aa2b615c1df69f1774a3a4f8a26bffa6e" title="Check to see if a 2d position is inside the viewport.">checkInViewport</a>(p2);
<a name="l00239"></a>00239             
<a name="l00240"></a>00240             <span class="keywordflow">if</span> ((p1[2] &gt; 0.0 &amp;&amp; p1InViewport) || (p2[2] &gt; 0.0 &amp;&amp; p2InViewport))
<a name="l00241"></a>00241             {
<a name="l00242"></a>00242                 smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a2754ad970dfcf6138a0234a78ba434c6" title="Add a new vertex to the end of the buffer.">addVertex</a>(<a class="code" href="structVertexP2.html" title="Vertex with only a 2D position.">VertexP2</a>(p1[0], p1[1]));
<a name="l00243"></a>00243                 <span class="keywordflow">if</span> (i + 1 == vertexList.constEnd())
<a name="l00244"></a>00244                 {
<a name="l00245"></a>00245                     smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a2754ad970dfcf6138a0234a78ba434c6" title="Add a new vertex to the end of the buffer.">addVertex</a>(<a class="code" href="structVertexP2.html" title="Vertex with only a 2D position.">VertexP2</a>(p2[0], p2[1]));
<a name="l00246"></a>00246                     drawSmallCircleVertexBuffer();
<a name="l00247"></a>00247                 }
<a name="l00248"></a>00248                 <span class="comment">// We crossed the edge of the viewport</span>
<a name="l00249"></a>00249                 <span class="keywordflow">if</span> (NULL != viewportEdgeIntersectCallback &amp;&amp; p1InViewport != p2InViewport)
<a name="l00250"></a>00250                 {
<a name="l00251"></a>00251                     <span class="comment">// if !p1InViewport, then p2InViewport</span>
<a name="l00252"></a>00252                     <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; a = p1InViewport ? p1 : p2;
<a name="l00253"></a>00253                     <span class="keyword">const</span> <a class="code" href="classVector3.html">Vec3d</a>&amp; b = p1InViewport ? p2 : p1;
<a name="l00254"></a>00254                     <a class="code" href="classVector3.html">Vec3d</a> dir = b - a;
<a name="l00255"></a>00255                     dir.normalize();
<a name="l00256"></a>00256                     viewportEdgeIntersectCallback(projector-&gt;<a class="code" href="classStelProjector.html#a18fc6eb0dba3ab3501890916b010b407" title="Return the position where the 2 2D point p1 and p2 cross the viewport edge P1 must be inside the view...">viewPortIntersect</a>(a, b),
<a name="l00257"></a>00257                                                   dir, userData);
<a name="l00258"></a>00258                 }
<a name="l00259"></a>00259             }
<a name="l00260"></a>00260             <span class="keywordflow">else</span>
<a name="l00261"></a>00261             {
<a name="l00262"></a>00262                 <span class="comment">// Break the line, draw the stored vertex and flush the list</span>
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> (smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a099305f64ca1066494e6bce062ba9253" title="Returns the number of vertices in the buffer.">length</a>() &gt; 0)
<a name="l00264"></a>00264                 {
<a name="l00265"></a>00265                     smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a2754ad970dfcf6138a0234a78ba434c6" title="Add a new vertex to the end of the buffer.">addVertex</a>(<a class="code" href="structVertexP2.html" title="Vertex with only a 2D position.">VertexP2</a>(p1[0], p1[1]));
<a name="l00266"></a>00266                 }
<a name="l00267"></a>00267                 drawSmallCircleVertexBuffer();
<a name="l00268"></a>00268             }
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         Q_ASSERT_X(smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a099305f64ca1066494e6bce062ba9253" title="Returns the number of vertices in the buffer.">length</a>() == 0, Q_FUNC_INFO,
<a name="l00272"></a>00272                    <span class="stringliteral">&quot;Small circle buffer must be empty after drawing&quot;</span>);
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 <span class="keyword">private</span>:
<a name="l00277"></a>00277     <a class="code" href="classStelRenderer.html" title="Main class of the Renderer subsystem.">StelRenderer</a>* renderer;
<a name="l00278"></a>00278 
<a name="l00280"></a>00280     <a class="code" href="classStelProjector.html" title="Provide the main interface to all operations of projecting coordinates from sky to screen...">StelProjector</a>* projector;
<a name="l00281"></a>00281 
<a name="l00283"></a>00283     <a class="code" href="classStelVertexBuffer.html">StelVertexBuffer&lt;VertexP2&gt;</a>* smallCircleVertexBuffer;
<a name="l00284"></a>00284 
<a name="l00286"></a>00286     QLinkedList&lt;Vec3d&gt; vertexList;  
<a name="l00287"></a>00287 
<a name="l00289"></a>00289     <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a> rotCenter;
<a name="l00290"></a>00290 
<a name="l00292"></a>00292     <span class="keywordtype">void</span> fIter(<span class="keyword">const</span> <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a>&amp; p1, <span class="keyword">const</span> <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a>&amp; p2, <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a>&amp; win1, <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a>&amp; win2, 
<a name="l00293"></a>00293                <span class="keyword">const</span> QLinkedList&lt;Vec3d&gt;::iterator&amp; iter, <span class="keywordtype">double</span> radius, 
<a name="l00294"></a>00294                <span class="keywordtype">int</span> nbI = 0, <span class="keywordtype">bool</span> checkCrossDiscontinuity = <span class="keyword">true</span>)
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296         <span class="keyword">const</span> <span class="keywordtype">bool</span> crossDiscontinuity = 
<a name="l00297"></a>00297             checkCrossDiscontinuity &amp;&amp; 
<a name="l00298"></a>00298             projector-&gt;<a class="code" href="classStelProjector.html#a1a45ecfa760d03883d53831285957f94" title="Determine whether a great circle connection p1 and p2 intersects with a projection discontinuity...">intersectViewportDiscontinuity</a>(p1 + rotCenter, p2 + rotCenter);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (crossDiscontinuity &amp;&amp; nbI &gt;= 5)
<a name="l00301"></a>00301         {
<a name="l00302"></a>00302             win1[2] = -2.0;
<a name="l00303"></a>00303             win2[2] = -2.0;
<a name="l00304"></a>00304             vertexList.insert(iter, win1);
<a name="l00305"></a>00305             vertexList.insert(iter, win2);
<a name="l00306"></a>00306             <span class="keywordflow">return</span>;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="comment">// Point splitting the tesselated line in two</span>
<a name="l00310"></a>00310         <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a> newVertex(p1 + p2); 
<a name="l00311"></a>00311         newVertex.normalize();
<a name="l00312"></a>00312         newVertex *= radius;
<a name="l00313"></a>00313         <a class="code" href="classVector3.html" title="A templatized 3d vector.">Vec3d</a> win3(newVertex + rotCenter);
<a name="l00314"></a>00314         <span class="keyword">const</span> <span class="keywordtype">bool</span> isValidVertex = projector-&gt;<a class="code" href="classStelProjector.html#a767ff36be1c3e69f98ddbaa61f6f98ae" title="Project the vector v from the current frame into the viewport.">projectInPlace</a>(win3);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="keyword">const</span> <span class="keywordtype">float</span> v10 = win1[0] - win3[0];
<a name="l00317"></a>00317         <span class="keyword">const</span> <span class="keywordtype">float</span> v11 = win1[1] - win3[1];
<a name="l00318"></a>00318         <span class="keyword">const</span> <span class="keywordtype">float</span> v20 = win2[0] - win3[0];
<a name="l00319"></a>00319         <span class="keyword">const</span> <span class="keywordtype">float</span> v21 = win2[1] - win3[1];
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="keyword">const</span> <span class="keywordtype">float</span> dist = std::sqrt((v10 * v10 + v11 * v11) * (v20 * v20 + v21 * v21));
<a name="l00322"></a>00322         <span class="keyword">const</span> <span class="keywordtype">float</span> cosAngle = (v10 * v20 + v11 * v21) / dist;
<a name="l00323"></a>00323         <span class="keywordflow">if</span> ((cosAngle &gt; -0.999f || dist &gt; 50 * 50 || crossDiscontinuity) &amp;&amp; nbI &lt; 5)
<a name="l00324"></a>00324         {
<a name="l00325"></a>00325             <span class="comment">// Use the 3rd component of the vector to store whether the vertex is valid</span>
<a name="l00326"></a>00326             win3[2]= isValidVertex ? 1.0 : -1.0;
<a name="l00327"></a>00327             fIter(p1, newVertex, win1, win3, vertexList.insert(iter, win3),
<a name="l00328"></a>00328                   radius, nbI + 1, crossDiscontinuity || dist &gt; 50 * 50);
<a name="l00329"></a>00329             fIter(newVertex, p2, win3, win2, iter, 
<a name="l00330"></a>00330                   radius, nbI + 1, crossDiscontinuity || dist &gt; 50 * 50);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 
<a name="l00335"></a>00335     <span class="keywordtype">void</span> drawSmallCircleVertexBuffer()
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337         smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a400a0947ede03659f9d16352792c29d3" title="Lock the buffer. Must be called before drawing.">lock</a>();
<a name="l00338"></a>00338         renderer-&gt;<a class="code" href="classStelRenderer.html#a1ff46049a6698fe6fb648d175052df4a" title="Draw contents of a vertex buffer.">drawVertexBuffer</a>(smallCircleVertexBuffer);
<a name="l00339"></a>00339         smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#abd0e9d5b7e8f83e3309c5810a024958b" title="Unlock the buffer. This is needed to modify the buffer after drawing.">unlock</a>();
<a name="l00340"></a>00340         smallCircleVertexBuffer-&gt;<a class="code" href="classStelVertexBuffer.html#a7647b1674aa08b548fbcebe799b1651a" title="Clear the buffer, removing all vertices.">clear</a>();
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342 };
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="preprocessor">#endif // _STELCIRCLEARCRENDERER_HPP_</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Feb 7 2013 11:48:05 for Stellarium by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
